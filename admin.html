<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ´»å‹•å¾Œå°ç®¡ç†</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

    :root {
      --primary: #06C755;
      --danger: #FF3B30;
      --bg: #f4f7f6;
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); padding: 20px; color: #2d3748; }
    .container { max-width: 500px; margin: 0 auto 40px auto; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    h1 { color: var(--primary); text-align: center; margin-bottom: 25px; font-size: 1.6rem; }
    h2 { font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; color: #4a5568; }
    input { width: 100%; padding: 14px; border: 2px solid #edf2f7; border-radius: 14px; box-sizing: border-box; font-size: 1rem; transition: all 0.2s; outline: none; }
    input:focus { border-color: var(--primary); background: #fafffb; }
    
    .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: transform 0.1s; }
    .btn:active { transform: scale(0.98); }
    .btn-submit { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3); }
    .btn-submit:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; }

    .event-list { list-style: none; padding: 0; margin: 0; }
    .event-item { border-bottom: 1px dashed #e2e8f0; padding: 16px 0; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .event-item:last-child { border-bottom: none; }
    
    .event-info { flex: 1; }
    .event-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 4px; color: #2d3748; }
    .event-meta { font-size: 0.85rem; color: #718096; display: flex; flex-direction: column; gap: 2px; }

    .del-btn { 
        color: var(--danger); background: #fff5f5; 
        padding: 8px 16px; border-radius: 10px; 
        font-weight: 600; font-size: 0.9rem; 
        cursor: pointer; border: 1px solid #fed7d7;
        white-space: nowrap;
    }
    .del-btn:hover { background: #ffebeb; }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ› ï¸ å»ºç«‹æ–°æ´»å‹•</h1>
  <div class="form-group"><label>æ´»å‹•æ¨™é¡Œ</label><input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šé€±äº”ç¾½çƒèš"></div>
  
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div class="form-group"><label>æ´»å‹•æ™‚é–“</label><input type="datetime-local" id="time"></div>
      <div class="form-group"><label>é–‹æ”¾å ±å</label><input type="datetime-local" id="openTime"></div>
  </div>
  <div class="form-group"><label>æˆªæ­¢å ±å</label><input type="datetime-local" id="closeTime"></div>
  
  <div class="form-group"><label>å ´åœ°åç¨±</label><input type="text" id="venue" placeholder="ä¾‹å¦‚ï¼šå¤§å®‰é‹å‹•ä¸­å¿ƒ"></div>
  <div class="form-group"><label>å®Œæ•´åœ°å€ (ä¾›å°èˆªç”¨)</label><input type="text" id="address" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚è¾›äº¥è·¯ä¸‰æ®µ55è™Ÿ"></div>
  
  <button id="btn-submit" class="btn btn-submit" onclick="publishEvent()">ç™¼ä½ˆä¸¦å…¬é–‹</button>

  <hr style="margin: 30px 0; border: 0; border-top: 2px dashed #eee;">

  <h2>ğŸ“‹ æˆ‘å»ºç«‹çš„æ´»å‹•</h2>
  <div id="my-events-list" style="text-align:center; color:#a0aec0;">è¼‰å…¥ä¸­...</div>
</div>

<script>
// âš ï¸ è«‹ç¢ºèªé€™è£¡å¡«å…¥çš„æ˜¯æ­£ç¢ºçš„ GAS éƒ¨ç½²ç¶²å€ (çµå°¾ç‚º /exec)
const GAS_URL='https://script.google.com/macros/s/AKfycbz4TwMhhZns3p2jc2tVTI376-6DU9CG8tkuRmL3KKcq_BmIuB2ySV2CKgaCc5eyS2vLnA/exec';

// âš ï¸ å»ºè­°ï¼šé€™é å¯ä»¥ç”³è«‹ä¸€å€‹å–®ç¨çš„ LIFF ID (ä¾‹å¦‚ Admin å°ˆç”¨)ï¼Œæˆ–è€…æ²¿ç”¨åŒä¸€å€‹ ID ä½†é€éåƒæ•¸å€åˆ†
const LIFF_ID='2008678090-N7n9nFaH';

let ADMIN_UID='', ADMIN_NICKNAME='';

async function init(){
  try {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile = await liff.getProfile();
      ADMIN_UID = profile.userId;
      ADMIN_NICKNAME = profile.displayName;
      loadMyEvents();
  } catch(e) {
      alert("LIFF åˆå§‹åŒ–å¤±æ•—");
  }
}

async function publishEvent(){
  const btn = document.getElementById('btn-submit');
  const payload = {
    action: 'createEvent',
    adminUid: ADMIN_UID,
    adminNickname: ADMIN_NICKNAME,
    title: document.getElementById('title').value.trim(),
    time: document.getElementById('time').value,
    openTime: document.getElementById('openTime').value,
    closeTime: document.getElementById('closeTime').value,
    venueName: document.getElementById('venue').value.trim(),
    address: document.getElementById('address').value.trim()
  };

  if(!payload.title || !payload.time || !payload.venueName) {
      return alert('è«‹è‡³å°‘å¡«å¯«ï¼šæ¨™é¡Œã€æ´»å‹•æ™‚é–“ã€å ´åœ°åç¨±');
  }

  // UX: é–å®šæŒ‰éˆ•é¿å…é‡è¤‡ç™¼é€
  btn.disabled = true;
  btn.textContent = "ğŸš€ ç™¼ä½ˆä¸­...";

  try {
      const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
      const data = await res.json();
      if(data.status === 'success'){
        alert('âœ… ç™¼ä½ˆæˆåŠŸï¼');
        // æ¸…ç©ºè¡¨å–®
        document.querySelectorAll('input').forEach(i => i.value = '');
        loadMyEvents(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
      } else {
        alert('âŒ ç™¼ä½ˆå¤±æ•—ï¼š' + data.message);
      }
  } catch(e) {
      alert('é€£ç·šéŒ¯èª¤');
  } finally {
      btn.disabled = false;
      btn.textContent = "ç™¼ä½ˆä¸¦å…¬é–‹";
  }
}

async function loadMyEvents(){
  const listDiv = document.getElementById('my-events-list');
  try {
      const res = await fetch(`${GAS_URL}?action=getMyEvents&adminUid=${ADMIN_UID}`);
      const data = await res.json();
      
      listDiv.innerHTML = '';
      
      if(!data.events || data.events.length === 0) {
          listDiv.innerHTML = '<p style="color:#cbd5e0; padding:20px;">å°šç„¡å»ºç«‹çš„æ´»å‹•</p>';
          return;
      }

      data.events.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'event-item';

        // ä½¿ç”¨ textContent ç¢ºä¿å®‰å…¨ (é˜² XSS)
        const infoDiv = document.createElement('div');
        infoDiv.className = 'event-info';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'event-title';
        titleDiv.textContent = ev.Title;

        const metaDiv = document.createElement('div');
        metaDiv.className = 'event-meta';
        metaDiv.innerHTML = `
            <span>ğŸ“… ${ev.Time.replace('T', ' ')}</span>
            <span>ğŸ“ ${ev.VenueName || '--'}</span>
        `; // é€™è£¡ä½¿ç”¨ innerHTML æ˜¯ç‚ºäº†æ’å…¥ span æ¨™ç±¤ï¼Œä½†è®Šæ•¸å…§å®¹è‹¥æ“”å¿ƒä¹Ÿå¯ä»¥å†æ‹†ç´°

        infoDiv.appendChild(titleDiv);
        infoDiv.appendChild(metaDiv);

        const delBtn = document.createElement('div');
        delBtn.className = 'del-btn';
        delBtn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
        delBtn.onclick = () => deleteEvent(ev.EventID);

        item.appendChild(infoDiv);
        item.appendChild(delBtn);
        listDiv.appendChild(item);
      });
  } catch(e) {
      listDiv.textContent = 'è®€å–å¤±æ•—';
  }
}

async function deleteEvent(id){
  if(!confirm('âš ï¸ è­¦å‘Šï¼š\nç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ\né€™å°‡æœƒä¸€ä½µç§»é™¤æ‰€æœ‰ã€Œå·²å ±åã€çš„è³‡æ–™ï¼')) return;
  
  // UX: çµ¦äºˆåˆªé™¤ä¸­çš„å›é¥‹ï¼Œé€™è£¡ç°¡å–®ç”¨ alert æˆ– loading é®ç½©çš†å¯ï¼Œé€™é‚Šç°¡åŒ–è™•ç†
  try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteEvent', eventId: id, adminUid: ADMIN_UID })
      });
      const data = await res.json();
      if(data.status === 'success') {
          // alert('å·²åˆªé™¤'); // å¯é¸ï¼Œé€šå¸¸ç›´æ¥åˆ·æ–°åˆ—è¡¨å³å¯
          loadMyEvents();
      } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
      }
  } catch(e) {
      alert('é€£ç·šéŒ¯èª¤');
  }
}

// å•Ÿå‹•
window.onload = init;
</script>
</body>
</html>
