<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF 多活動報名表單</title>
    <script src="https://static.line-scdn.net/liff/2.22.3/liff.js"></script>
    <style>
        /* CSS 樣式部分保持不變 */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h1 { color: #00b900; border-bottom: 3px solid #00b900; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .info-card, .form-section, .stats-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .info-card h2, .form-section h2 { margin-top: 0; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-group { margin-top: 20px; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; transition: background-color 0.3s; }
        .btn-register { background-color: #00b900; color: white; }
        .btn-register:hover { background-color: #009900; }
        .btn-cancel { background-color: #ff3b30; color: white; }
        .btn-cancel:hover { background-color: #cc0000; }
        .btn-modify { background-color: #007aff; color: white; }
        .btn-modify:hover { background-color: #005bb5; }
        .message { padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; font-weight: bold; display: none; }
        .success { background-color: #e6ffe6; color: #009900; border: 1px solid #009900; }
        .error { background-color: #ffe6e6; color: #cc0000; border: 1px solid #cc0000; }
        .stats-list { list-style: none; padding-left: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .stats-list li { padding: 5px 0; border-bottom: 1px dotted #eee; }
        .stats-list li:last-child { border-bottom: none; }
        #form-actions { display: flex; justify-content: space-around; }
        .loading { text-align: center; padding: 30px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>多活動報名表單</h1>

        <div id="loading-spinner" class="loading">
            <p>載入中，請稍候...</p>
        </div>

        <div id="event-selection" class="form-section" style="display: none;">
            <h2>選擇報名活動</h2>
            <label for="event-select">可報名活動列表</label>
            <select id="event-select" onchange="selectEvent(this.value)">
                <option value="">-- 請選擇一項活動 --</option>
                </select>
            <div id="select-message" class="message"></div>
        </div>
        
        <div id="activity-info" class="info-card" style="display: none;">
            <h2>活動資訊 - <span id="info-title"></span></h2>
            <p><strong>主辦:</strong> <span id="info-organizer"></span></p>
            <p><strong>時間:</strong> <span id="info-time"></span></p>
            <p><strong>地點:</strong> <span id="info-location"></span> (<a id="info-map-link" href="#" target="_blank">Google 地圖</a>)</p>
        </div>

        <div id="registration-form" class="form-section" style="display: none;">
            <h2>您的報名資料</h2>
            
            <p><strong>參加人姓名:</strong> <span id="line-nickname">載入中...</span></p>
            <input type="hidden" id="line-uid">

            <label for="attendees-count">參加人數 (含您本人)</label>
            <select id="attendees-count">
                </select>

            <label for="guest-names">來賓姓名 (請用逗號分隔)</label>
            <textarea id="guest-names" rows="2" placeholder="例如：王小明, 陳小美"></textarea>

            <div class="btn-group">
                <div id="form-actions">
                    </div>
            </div>

            <div id="form-message" class="message"></div>
        </div>

        <div id="statistics" class="stats-section" style="display: none;">
            <h2>即時報名統計</h2>
            <p>目前總計 **<span id="total-attendees">0</span>** 人參加</p>
            <p>參加者名單:</p>
            <ul id="registered-list" class="stats-list">
                </ul>
            <button class="btn btn-modify" onclick="if(CURRENT_EVENT_ID) loadStatsAndStatus(CURRENT_EVENT_ID, true)">重新整理統計</button>
        </div>
    </div>

    <script>
        // !! 請將 YOUR_GAS_WEB_APP_URL 替換為您在步驟 2 部署 GAS 後取得的「網路應用程式網址」 !!
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4TwMhhZns3p2jc2tVTI376-6DU9CG8tkuRmL3KKcq_BmIuB2ySV2CKgaCc5eyS2vLnA/exec';
        
        let LINE_UID = '';
        let LINE_NICKNAME = '';
        let CURRENT_EVENT_ID = null; 
        let ALL_EVENTS = []; 

        // --- 初始化 LIFF (不變) ---
        function initializeLiff() {
            liff.init({ liffId: '2008678090-b1Up4o0J' }) 
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    if (!liff.getIDToken()) {
                        alert('無法取得 LINE 資訊。');
                        document.getElementById('loading-spinner').style.display = 'none';
                        return;
                    }
                    
                    liff.getProfile().then(profile => {
                        LINE_UID = profile.userId;
                        LINE_NICKNAME = profile.displayName;
                        document.getElementById('line-nickname').textContent = LINE_NICKNAME;
                        document.getElementById('line-uid').value = LINE_UID;
                        
                        // 載入活動列表，並填充到下拉選單
                        loadEventsList();
                        
                    }).catch(err => {
                        console.error("Error getting profile: ", err);
                        alert('無法取得 LINE 個人資料，請稍後再試。');
                        document.getElementById('loading-spinner').style.display = 'none';
                    });

                })
                .catch((err) => {
                    console.error("LIFF initialization failed", err);
                    alert('LIFF 初始化失敗。');
                    document.getElementById('loading-spinner').style.display = 'none';
                });
        }
        
        // --- 載入活動列表 (修改渲染方式) ---
        async function loadEventsList() {
            try {
                const url = `${GAS_WEB_APP_URL}?action=getEventsList`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    ALL_EVENTS = result.events;
                    
                    // 填充活動下拉選單
                    renderEventDropdown(ALL_EVENTS);
                    
                    document.getElementById('event-selection').style.display = 'block';
                    
                    // 產生參加人數下拉選單 (只需產生一次)
                    const select = document.getElementById('attendees-count');
                    if (select.options.length === 0) {
                        for (let i = 1; i <= 10; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = i;
                            select.appendChild(option);
                        }
                    }

                } else {
                    displaySelectMessage('error', '載入活動列表失敗: ' + result.message);
                }
            } catch (error) {
                console.error("Fetch events list error:", error);
                displaySelectMessage('error', '連線錯誤，無法載入活動列表。');
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }
        
        // --- 新增：渲染活動下拉選單 ---
        function renderEventDropdown(events) {
            const select = document.getElementById('event-select');
            select.innerHTML = '<option value="">-- 請選擇一項活動 --</option>'; // 重置選單
            
            if (events.length === 0) {
                displaySelectMessage('error', '目前沒有開放報名的活動。');
                return;
            }
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.EventID;
                option.textContent = `${event.Title} (${event.Time})`;
                select.appendChild(option);
            });
        }
        
        // --- 選擇活動，顯示表單 (透過下拉選單的 onchange 觸發) ---
        function selectEvent(eventId) {
            // 如果選擇了預設的空值，就隱藏表單
            if (!eventId) {
                hideFormAndStats();
                return;
            }
            
            CURRENT_EVENT_ID = eventId;
            const event = ALL_EVENTS.find(e => e.EventID === eventId);
            
            if (!event) {
                alert('活動 ID 錯誤，請重新選擇。');
                hideFormAndStats();
                return;
            }
            
            // 填充單一活動資訊
            document.getElementById('info-title').textContent = event.Title || 'N/A';
            document.getElementById('info-organizer').textContent = event.Organizer || 'N/A';
            document.getElementById('info-time').textContent = event.Time || 'N/A';
            document.getElementById('info-location').textContent = event.Location || 'N/A';
            document.getElementById('info-map-link').href = event.MapUrl || '#';
            
            // 顯示表單和統計區塊
            document.getElementById('activity-info').style.display = 'block';
            document.getElementById('registration-form').style.display = 'block';
            document.getElementById('statistics').style.display = 'block';
            
            // 載入特定活動的統計和用戶狀態
            loadStatsAndStatus(CURRENT_EVENT_ID);
        }

        // --- 隱藏表單和統計區塊 (用於切換活動或選擇空值時) ---
        function hideFormAndStats() {
            CURRENT_EVENT_ID = null;
            document.getElementById('activity-info').style.display = 'none';
            document.getElementById('registration-form').style.display = 'none';
            document.getElementById('statistics').style.display = 'none';
            hideMessage();
        }
