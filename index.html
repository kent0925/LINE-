<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>LIFF 活動報名</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ✅ 官方正確 LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: Arial; background:#f5f5f5; padding:20px }
    .box { background:#fff; padding:20px; max-width:500px; margin:auto; border-radius:8px }
    h2 { color:#00b900 }
    select, textarea, button { width:100%; margin-top:10px; padding:10px }
    button { background:#00b900; color:#fff; border:0; border-radius:4px }
    .msg { margin-top:10px; font-weight:bold }
  </style>
</head>
<body>

<div class="box">
  <h2>活動報名</h2>

  <p>LINE 使用者：<span id="nickname">載入中…</span></p>

  <label>選擇活動</label>
  <select id="eventSelect"></select>

  <label>參加人數</label>
  <select id="count">
    <option value="1">1 人</option>
    <option value="2">2 人</option>
    <option value="3">3 人</option>
    <option value="4">4 人</option>
    <option value="5">5 人</option>
    <option value="6">6 人</option>
    <option value="7">7 人</option>
    <option value="8">8 人</option>
    <option value="9">9 人</option>
    
  </select>

  <label>同行者姓名</label>
  <textarea id="guests"></textarea>

  <button onclick="register()">送出報名</button>

  <div id="msg" class="msg"></div>
</div>

<script>
const LIFF_ID = '你的 LIFF_ID';
const GAS_URL = '你的 GAS /exec URL';

let LINE_UID = '';
let LINE_NAME = '';
let CURRENT_EVENT = '';

/**************
 * LIFF INIT
 **************/
liff.init({ liffId: LIFF_ID })
.then(() => {
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }
  return liff.getProfile();
})
.then(p => {
  LINE_UID = p.userId;
  LINE_NAME = p.displayName;
  document.getElementById('nickname').textContent = LINE_NAME;
  loadEvents();
});

/**************
 * GET 活動
 **************/
function loadEvents() {
  fetch(GAS_URL + '?action=getEventsList')
    .then(r => r.json())
    .then(res => {
      const sel = document.getElementById('eventSelect');
      sel.innerHTML = '<option value="">請選擇</option>';
      res.events.forEach(e => {
        const o = document.createElement('option');
        o.value = e.EventID;
        o.textContent = `${e.Title}（${e.Time}）`;
        sel.appendChild(o);
      });
    });
}

/**************
 * POST（form-urlencoded）
 **************/
function post(data) {
  const body = Object.keys(data)
    .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
    .join('&');

  return fetch(GAS_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body
  }).then(r => r.json());
}

/**************
 * 報名
 **************/
function register() {
  CURRENT_EVENT = document.getElementById('eventSelect').value;
  if (!CURRENT_EVENT) {
    show('請選擇活動');
    return;
  }

  post({
    action: 'register',
    eventId: CURRENT_EVENT,
    lineUid: LINE_UID,
    lineNickname: LINE_NAME,
    attendeesCount: document.getElementById('count').value,
    guestNames: document.getElementById('guests').value
  })
  .then(res => {
    show(res.message || '完成');
  })
  .catch(() => {
    show('連線錯誤');
  });
}

function show(t) {
  document.getElementById('msg').textContent = t;
}
</script>

</body>
</html>
