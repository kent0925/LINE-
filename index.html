<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>活動報名系統</title>
<style>
.hidden { display: none; }
button { margin: 5px; padding: 8px 16px; }
</style>
</head>
<body>

<h2>活動報名</h2>

<select id="event-select">
    <option value="">請選擇活動</option>
</select>

<div id="event-details-box" class="hidden">
    <p><strong>活動名稱：</strong><span id="event-title"></span></p>
    <p><strong>時間：</strong><span id="event-time"></span></p>
    <p><strong>地點：</strong><span id="event-location"></span></p>
</div>

<div id="statistics-box" class="hidden">
    <p><strong>已報名人數：</strong><span id="signup-count"></span></p>
    <p><strong>名單：</strong><span id="signup-list"></span></p>
</div>

<form id="mainForm" class="hidden">
    <label>人數：
        <input type="number" id="count" min="1" value="1">
    </label>
    <br>
    <label>攜伴：
        <input type="text" id="guests" placeholder="可留空">
    </label>
    <br>
    <button type="button" id="signupBtn">確認報名</button>
    <button type="button" id="updateBtn" class="hidden">修改報名</button>
    <button type="button" id="cancelBtn" class="hidden">取消報名</button>
</form>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbziu7Klm6jnvhR8EzbxfacXaDU7amAoeQsXmF85ayqGObOYqt7mxWIwIyPihMrm2rc_/exec'; // <-- 替換成你的 GAS Web App URL
let ALL_EVENTS = [];
let USER_SIGNUP_DATA = {};

// ==================== 取得活動與使用者報名狀態 ====================
async function fetchEventData(userId) {
    const res = await fetch(`${GAS_URL}?u=${userId}`);
    const data = await res.json();
    ALL_EVENTS = data.eventList || [];
    USER_SIGNUP_DATA = data.userData || {};
    populateEventSelect();
}

// ==================== 下拉選單填充 ====================
function populateEventSelect() {
    const select = document.getElementById('event-select');
    select.innerHTML = '<option value="">請選擇活動</option>';
    ALL_EVENTS.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.EventID;
        opt.textContent = e.Title;
        select.appendChild(opt);
    });
}

// ==================== 顯示活動細節 ====================
function displayEventDetails(event) {
    document.getElementById('event-title').textContent = event.Title;
    document.getElementById('event-time').textContent = event.Time;
    document.getElementById('event-location').textContent = event.Address || event.Location;
}

// ==================== 顯示報名按鈕 ====================
function showButtons(userStatus) {
    const signupBtn = document.getElementById('signupBtn');
    const updateBtn = document.getElementById('updateBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    if (userStatus === 'SIGNUP' || userStatus === 'UPDATE') {
        signupBtn.classList.add('hidden');
        updateBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
    } else {
        signupBtn.classList.remove('hidden');
        updateBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
    }
}

// ==================== 顯示報名統計 ====================
function updateStatisticsDisplay(eventId) {
    const statsBox = document.getElementById('statistics-box');
    const countEl = document.getElementById('signup-count');
    const listEl = document.getElementById('signup-list');

    const eventStats = ALL_EVENTS.find(e => e.EventID === eventId);
    const userStats = eventStats ? USER_SIGNUP_DATA[eventId] : null;

    // 假設沒有其他統計資料，僅顯示人數
    countEl.textContent = userStats?.count || 0;
    listEl.textContent = userStats?.guests || '-';

    statsBox.classList.remove('hidden');
}

// ==================== 活動選擇處理 ====================
function handleEventSelection() {
    const select = document.getElementById('event-select');
    const eventId = select.value;
    const form = document.getElementById('mainForm');
    const detailsBox = document.getElementById('event-details-box');

    if (!eventId) {
        form.classList.add('hidden');
        detailsBox.classList.add('hidden');
        return;
    }

    const selectedEvent = ALL_EVENTS.find(e => e.EventID === eventId);
    const currentUserSignup = USER_SIGNUP_DATA[eventId];
    const userStatus = currentUserSignup?.status || 'NONE';

    if (selectedEvent) {
        displayEventDetails(selectedEvent);

        // 填表單
        document.getElementById('count').value = currentUserSignup?.count || 1;
        document.getElementById('guests').value = currentUserSignup?.guests || '';

        showButtons(userStatus);
        form.classList.remove('hidden');
    }
}

// ==================== 提交報名 ====================
async function handleSubmit(action) {
    const select = document.getElementById('event-select');
    const eventId = select.value;
    const count = document.getElementById('count').value;
    const guests = document.getElementById('guests').value;
    const lineUserId = 'USER_LINE_ID'; // <-- 替換成使用者 LINE ID
    const lineName = 'USER_LINE_NAME'; // <-- 替換成使用者 LINE 名稱

    const formData = { action, lineUserId, lineName, eventId, count, guests };

    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(formData),
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        // 更新本地狀態
        USER_SIGNUP_DATA[eventId] = action === 'cancel'
            ? { status: 'CANCEL', count, guests }
            : { status: 'SIGNUP', count, guests };

        handleEventSelection(); // 立即刷新按鈕

        alert(action === 'cancel' ? '已取消報名' : '報名成功');
    } catch (err) {
        console.error(err);
        alert('發生錯誤，請重試');
    }
}

// ==================== 綁定事件 ====================
document.getElementById('event-select').addEventListener('change', handleEventSelection);
document.getElementById('signupBtn').addEventListener('click', () => handleSubmit('signup'));
document.getElementById('updateBtn').addEventListener('click', () => handleSubmit('update'));
document.getElementById('cancelBtn').addEventListener('click', () => handleSubmit('cancel'));

// ==================== 初始化 ====================
fetchEventData('USER_LINE_ID'); // <-- 替換成使用者 LINE ID
</script>

</body>
</html>
