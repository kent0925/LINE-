<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å„é …æ´»å‹•å ±åè¡¨å–®</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
/* ä¿æŒæ‚¨çš„ CSS æ¨£å¼ä¸è®Š */
:root {
Â  Â  --primary-color: #00796b; /* æ·±ç¶  (Primary) */
Â  Â  --secondary-color: #4db6ac; /* æ·ºç¶  (Accent) */
Â  Â  --bg-color: #f0f8ff; /* æ·ºè—ç™½ (Background) */
Â  Â  --box-bg-color: #ffffff; /* ç™½è‰² (Card Background) */
Â  Â  --input-bg-color: #f9f9f9; /* è¼¸å…¥æ¬„ä½æ·ºç° */
Â  Â  --success-color: #4caf50; /* æˆåŠŸç¶  */
Â  Â  --warning-color: #ff9800; /* è­¦å‘Šæ©˜ */
Â  Â  --danger-color: #e53935; /* å±éšªç´… */
Â  Â  --stat-color: #00897b; /* çµ±è¨ˆæ·±ç¶  */
Â  Â  --border-color: #e0e0e0; /* é‚Šæ¡†æ·ºç° */
}
body {Â 
Â  Â  font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;Â 
Â  Â  background-color: var(--bg-color);Â 
Â  Â  padding: 0;
Â  Â  margin: 0;
}
.container {Â 
Â  Â  max-width: 500px;Â 
Â  Â  margin: 20px auto;Â 
Â  Â  background: var(--box-bg-color);Â 
Â  Â  padding: 25px;Â 
Â  Â  border-radius: 16px; /* æ›´åœ“æ½¤ */
Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* æ›´æ˜é¡¯çš„é™°å½± */
}
h2 {Â 
Â  Â  text-align: center;Â 
Â  Â  color: var(--primary-color);Â 
Â  Â  border-bottom: 3px solid var(--secondary-color);Â 
Â  Â  padding-bottom: 12px;Â 
Â  Â  margin-bottom: 30px;Â 
Â  Â  font-size: 1.8em;
}
.info-box, .statistics-box {Â 
Â  Â  background: var(--box-bg-color);Â 
Â  Â  padding: 20px;Â 
Â  Â  border-radius: 12px;Â 
Â  Â  margin-bottom: 25px;Â 
Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* è¼•å¾®é™°å½± */
Â  Â  border: 1px solid var(--border-color);
}
.info-box h3, .statistics-box h3 {
Â  Â  margin-top: 0;
Â  Â  font-size: 1.2em;
Â  Â  color: var(--primary-color);
Â  Â  border-bottom: 1px dashed var(--border-color);
Â  Â  padding-bottom: 10px;
Â  Â  margin-bottom: 15px;
}
.info-item {Â 
Â  Â  margin-bottom: 8px;Â 
Â  Â  line-height: 1.5;Â 
Â  Â  display: flex; /* ä½¿ç”¨ Flex æ’ç‰ˆ */
}
.info-label {Â 
Â  Â  font-weight: bold;Â 
Â  Â  color: #333;Â 
Â  Â  min-width: 50px; /* çµ±ä¸€æ¨™ç±¤å¯¬åº¦ */
Â  Â  margin-right: 10px;
}
#mapLinkBox a { color: var(--secondary-color) !important; text-decoration: underline; font-weight: bold; }
label {Â 
Â  Â  display: block;Â 
Â  Â  margin-top: 20px;Â 
Â  Â  margin-bottom: 5px;
Â  Â  font-weight: bold;Â 
Â  Â  color: var(--primary-color); /* è®“æ¨™ç±¤æ›´çªå‡º */
Â  Â  font-size: 1.05em;
}
input, select, textarea {Â 
Â  Â  width: 100%;Â 
Â  Â  padding: 12px; /* å¢åŠ é»æ“Šå€åŸŸ */
Â  Â  background-color: var(--input-bg-color);
Â  Â  border: 1px solid var(--border-color);Â 
Â  Â  border-radius: 8px;Â 
Â  Â  box-sizing: border-box;Â 
Â  Â  transition: border-color 0.3s, box-shadow 0.3s;Â 
}
input:focus, select:focus, textarea:focus {
Â  Â  border-color: var(--primary-color);
Â  Â  box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2); /* ç„¦é»è—è‰²å…‰æšˆ */
Â  Â  background-color: var(--box-bg-color);
}
input[readonly] {
Â  Â  background-color: #e8e8e8;
Â  Â  color: #666;
Â  Â  font-weight: bold;
}
.btn-group {Â 
Â  Â  margin-top: 40px;Â 
Â  Â  display: flex;Â 
Â  Â  flex-direction: column; /* æ”¹ç‚ºå‚ç›´å †ç–Šä»¥å„ªåŒ–è¡Œå‹•è£ç½®é«”é©— */
Â  Â  gap: 15px;Â 
}
button {Â 
Â  Â  width: 100%;
Â  Â  padding: 15px; /* å¢åŠ é»æ“Šå€åŸŸ */
Â  Â  border: none;Â 
Â  Â  border-radius: 8px;Â 
Â  Â  cursor: pointer;Â 
Â  Â  font-size: 1.1em;Â 
Â  Â  color: white;Â 
Â  Â  font-weight: bold;Â 
Â  Â  transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;Â 
Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.15);Â 
}
#signupBtn { background-color: var(--success-color); }
#updateBtn { background-color: var(--warning-color); }
#cancelBtn { background-color: var(--danger-color); }
button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
button:disabled { background-color: #b0bec5; cursor: not-allowed; box-shadow: none; transform: none; }
.statistics-box {Â 
Â  Â  background-color: #e8f5e9; /* æ·ºç¶ åº•è‰² */
Â  Â  border: 1px solid var(--success-color);Â 
Â  Â  padding: 20px;Â 
Â  Â  border-radius: 12px;Â 
Â  Â  margin-top: 30px;Â 
}
.statistics-box h3 {Â 
Â  Â  color: var(--stat-color);Â 
Â  Â  margin-top: 0;Â 
Â  Â  margin-bottom: 10px;Â 
Â  Â  border-bottom: 2px solid var(--stat-color);Â 
Â  Â  padding-bottom: 5px;Â 
Â  Â  font-size: 1.2em;Â 
Â  Â  display: flex;
Â  Â  align-items: center;
}
.statistics-box h3::before {
Â  Â  content: "ğŸ“Š";
Â  Â  margin-right: 8px;
Â  Â  font-size: 1.1em;
}
.stat-item {Â 
Â  Â  font-weight: 500;Â 
Â  Â  color: #333;Â 
Â  Â  margin-bottom: 8px;Â 
Â  Â  padding-left: 10px;
Â  Â  border-left: 3px solid var(--secondary-color);
}
#nameList {Â 
Â  Â  margin-top: 15px;Â 
Â  Â  font-size: 0.9em;Â 
Â  Â  line-height: 1.8;Â 
Â  Â  color: #555;Â 
Â  Â  white-space: pre-wrap;Â 
Â  Â  padding: 10px;
Â  Â  background-color: #ffffff;
Â  Â  border: 1px solid #eee;
Â  Â  border-radius: 6px;
}
.hidden { display: none !important; }
#loading {
Â  Â  padding: 10px;
Â  Â  background-color: #fff3e0;
Â  Â  border-radius: 6px;
Â  Â  border: 1px solid var(--warning-color);
Â  Â  margin-top: 15px;
Â  Â  color: #666;
Â  Â  font-style: italic;
}
</style>
</head>
<body>

<div class="container">
<h2 id="pageTitle">æ´»å‹•å ±åè¡¨å–®</h2>

<div id="event-selection-area" class="info-box" style="padding: 15px; background: #fff;">
<label for="event-select" style="margin-top: 0;">è«‹é¸æ“‡æ´»å‹•</label>
<select id="event-select" onchange="handleEventSelection()">
Â  Â  <option value="" disabled selected>-- æ­£åœ¨è¼‰å…¥æ´»å‹• --</option>
</select>
<div id="loading" style="margin-top: 10px; color: #666;">æ­£åœ¨åˆå§‹åŒ– LIFF ä¸¦è®€å–æ´»å‹•è³‡è¨Š...</div>
</div>

<div id="event-details-box" class="info-box hidden">
Â  Â  <h3>æ´»å‹•è©³ç´°è³‡è¨Š</h3>
Â  Â  <div class="info-item"><span class="info-label">ä¸»é¡Œ</span> <span id="eventTitle">...</span></div>
Â  Â  <div class="info-item"><span class="info-label">ä¸»è¾¦</span> <span id="organizer">...</span></div>
Â  Â  <div class="info-item"><span class="info-label">æ™‚é–“</span> <span id="time">...</span></div>
Â  Â  <div class="info-item"><span class="info-label">åœ°é»</span> <span id="location">...</span></div>
Â  Â  <div class="info-item"><span class="info-label">åœ°å€</span> <span id="address">...</span></div>
Â  Â  <div class="info-item" id="mapLinkBox"></div>
</div>

<form id="mainForm" class="hidden">
<input type="hidden" id="lineUserId">
<input type="hidden" id="eventID">Â 
<label>åƒåŠ äººå§“å (LINE)</label>
<input type="text" id="lineName" readonly placeholder="è®€å–ä¸­...">
<label>åƒåŠ äººæ•¸ (å«æœ¬äººåŠä¾†è³“)</label>
<select id="count">
Â  Â  <option value="1">1</option><option value="2">2</option><option value="3">3</option>
Â  Â  <option value="4">4</option><option value="5">5</option><option value="6">6</option>
Â  Â  <option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
</select>
<label>ä¾†è³“å§“å</label>
<textarea id="guests" rows="3" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜, æå¤§è¯ (å¦‚æœåªæœ‰ä¸€äººåƒåŠ ï¼Œå¯ç•™ç©º)"></textarea>

<div class="btn-group">
<button type="button" id="signupBtn" class="hidden" onclick="handleSubmit('signup')">ç¢ºèªå ±å</button>
<button type="button" id="updateBtn" class="hidden" onclick="handleSubmit('update')">ä¿®æ”¹è³‡æ–™</button>
<button type="button" id="cancelBtn" class="hidden" onclick="handleSubmit('cancel')">å–æ¶ˆå ±å</button>
</div>
</form>

<div id="statistics-box" class="statistics-box hidden">
Â  Â  <h3>å³æ™‚å ±åç‹€æ³</h3>
Â  Â  <div class="stat-item">å ±åç­†æ•¸ (LINE ID)ï¼š <span id="statSignupCount">0</span> ç­†</div>
Â  Â  <div class="stat-item">ç¸½åƒåŠ äººæ•¸ï¼š <span id="statTotalCount">0</span> äºº</div>
Â  Â  <h4 style="color: var(--stat-color); margin-top: 15px; margin-bottom: 5px; font-size: 1em;">å·²å ±åè€…åå–® (LINE æš±ç¨±)ï¼š</h4>
Â  Â  <div id="nameList">è¼‰å…¥ä¸­...</div>
</div>

</div>

<script>
// ==================== [è«‹å‹™å¿…æ›´æ–°] æ‚¨çš„ LIFF ID ====================
// è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› LIFF ID
const LIFF_ID = "2008678090-b1Up4o0J";Â Â 
// ==================== [è«‹å‹™å¿…æ›´æ–°] æ‚¨çš„ Google Apps Script URL ====================
// è«‹æ›¿æ›ç‚ºæ‚¨æœ€æ–°éƒ¨ç½²çš„ /exec ç¶²å€
const GAS_URL = "https://script.google.com/macros/s/AKfycbz7gRmURD0nBYfetyyid8Y7kjV_Lqmkp1L8vNq1fMvLuI_ti4OTqQNHdW39Zliwd-8H/exec";Â 

let ALL_EVENTS = [];
let USER_SIGNUP_DATA = {};
let ALL_EVENT_STATS = null;
const SIGNUP_STATUSES = ['SIGNUP','UPDATE'];

document.addEventListener('DOMContentLoaded', async () => {
Â  Â  await initLIFF();
});

/** è¼”åŠ©å‡½æ•¸ï¼šå–å¾— DOM å…ƒç´  */
const getEl = (id) => document.getElementById(id);

// ** æ ¸å¿ƒåŠŸèƒ½ 1: LIFF åˆå§‹åŒ–èˆ‡ç”¨æˆ¶è³‡æ–™ç²å– **
async function initLIFF() {
Â  Â  try {
Â  Â  Â  Â  await liff.init({ liffId: LIFF_ID });
Â  Â  Â  Â  getEl('loading').innerText = 'æ­£åœ¨é©—è­‰ LINE ç™»å…¥ç‹€æ…‹...';

Â  Â  Â  Â  if (liff.isLoggedIn()) {
Â  Â  Â  Â  Â  Â  const profile = await liff.getProfile();
Â  Â  Â  Â  Â  Â  const userName = profile.displayName;
Â  Â  Â  Â  Â  Â  const userId = profile.userId;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  getEl('lineName').value = userName;
Â  Â  Â  Â  Â  Â  getEl('lineUserId').value = userId;Â 
Â  Â  Â  Â  Â  Â  getEl('pageTitle').innerText = 'æ´»å‹•å ±åè¡¨å–® - ' + userName;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  await fetchData(userId);Â 
Â  Â  Â  Â  } else if (!liff.isInClient()) {Â 
Â  Â  Â  Â  Â  Â  // å¤–éƒ¨ç€è¦½å™¨éœ€è¦ç™»å…¥
Â  Â  Â  Â  Â  Â  liff.login();Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  getEl('loading').innerText = 'LIFF éŒ¯èª¤ï¼šç„¡æ³•åœ¨ LINE å…§å–å¾—ç”¨æˆ¶è³‡æ–™ã€‚';
Â  Â  Â  Â  }
Â  Â  } catch (err) {Â 
Â  Â  Â  Â  console.error("LIFF/åˆå§‹åŒ–éŒ¯èª¤:", err);
Â  Â  Â  Â  alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID æˆ–ç¶²è·¯é€£ç·šã€‚éŒ¯èª¤è¨Šæ¯: ' + err.message);Â 
Â  Â  Â  Â  getEl('loading').innerText = 'LIFF åˆå§‹åŒ–å¤±æ•—ã€‚';
Â  Â  }
}

// ** æ ¸å¿ƒåŠŸèƒ½ 2: å¾ GAS è®€å–è³‡æ–™ (GET Request) **
async function fetchData(userId) {Â 
Â  Â  try {
Â  Â  Â  Â  getEl('loading').innerText = 'æ­£åœ¨è®€å–æ´»å‹•è³‡æ–™åŠæ‚¨çš„å ±åç‹€æ…‹...';
Â  Â  Â  Â  const url = `${GAS_URL}?u=${encodeURIComponent(userId)}`;
Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  getEl('loading').classList.add('hidden');

Â  Â  Â  Â  if(data.status==='error'){Â 
Â  Â  Â  Â  Â  Â  alert("å¾Œç«¯è¨­å®šéŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥ GAS ç¨‹å¼ç¢¼æˆ– Google Sheetï¼š\n" + data.message);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  ALL_EVENTS = data.eventList || [];
Â  Â  Â  Â  ALL_EVENT_STATS = data.eventStats;
Â  Â  Â  Â  USER_SIGNUP_DATA = data.userData && typeof data.userData==='object' ? data.userData : {};

Â  Â  Â  Â  if(ALL_EVENTS.length===0){
Â  Â  Â  Â  Â  Â  getEl('event-selection-area').innerHTML = '<div style="color:red; font-weight:bold;">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•ï¼</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  populateEventSelect(ALL_EVENTS);

Â  Â  Â  Â  // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹æ´»å‹•
Â  Â  Â  Â  const selectEl = getEl('event-select');
Â  Â  Â  Â  if(!selectEl.value && ALL_EVENTS.length > 0){Â 
Â  Â  Â  Â  Â  Â  selectEl.value = ALL_EVENTS[0].EventID;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  handleEventSelection();

Â  Â  } catch(err){Â 
Â  Â  Â  Â  console.error("Fetch Data éŒ¯èª¤:", err);
Â  Â  Â  Â  let errMsg = "è®€å–æ´»å‹•æˆ–å ±åè³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯è¨­å®šã€‚";
Â  Â  Â  Â  if (err.message.includes("Failed to fetch") || err.message.includes("CORS")) {
Â  Â  Â  Â  Â  Â  Â errMsg = "âŒ é€£ç·šå¾Œç«¯ä¼ºæœå™¨å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œä¸”ã€å­˜å–æ¬Šã€‘æ˜¯å¦è¨­å®šç‚ºã€Œä»»ä½•äººã€ã€‚";
Â  Â  Â  Â  }
Â  Â  Â  Â  alert(errMsg);
Â  Â  Â  Â  getEl('loading').innerText = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šæˆ–è¨­å®šã€‚';
Â  Â  }
}

// ** è¼”åŠ©åŠŸèƒ½: å¡«å……æ´»å‹•ä¸‹æ‹‰é¸å–® **
function populateEventSelect(events){
Â  Â  const select = getEl('event-select');
Â  Â  select.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡ä¸€å€‹æ´»å‹• --</option>';
Â  Â  events.forEach(event=>{
Â  Â  Â  Â  let optionText = `${event.Title} (${event.Time})`;
Â  Â  Â  Â  const userStatus = USER_SIGNUP_DATA[event.EventID] ? String(USER_SIGNUP_DATA[event.EventID].status).toUpperCase() : 'NONE';
Â  Â  Â  Â  if(SIGNUP_STATUSES.includes(userStatus)){ optionText += ' (å·²å ±å)'; }
Â  Â  Â  Â  else if(userStatus==='CANCEL'){ optionText += ' (å·²å–æ¶ˆ)'; }
Â  Â  Â  Â  select.innerHTML += `<option value="${event.EventID}">${optionText}</option>`;
Â  Â  });
}

// ** è¼”åŠ©åŠŸèƒ½: è™•ç†æ´»å‹•é¸æ“‡èˆ‡è¡¨å–®ç‹€æ…‹åˆ‡æ› **
function handleEventSelection(){
Â  Â  const eventId = getEl('event-select').value;
Â  Â  const form = getEl('mainForm');
Â  Â  const detailsBox = getEl('event-details-box');
Â  Â  const statsBox = getEl('statistics-box');

Â  Â  if(!eventId){ form.classList.add('hidden'); detailsBox.classList.add('hidden'); statsBox.classList.add('hidden'); return; }

Â  Â  getEl('eventID').value = eventId;
Â  Â  const selectedEvent = ALL_EVENTS.find(e=>e.EventID===eventId);
Â  Â  const currentUserSignup = USER_SIGNUP_DATA[eventId];
Â  Â  let userStatus = currentUserSignup?.status ? String(currentUserSignup.status).toUpperCase() : 'NONE';

Â  Â  if(selectedEvent){
Â  Â  Â  Â  displayEventDetails(selectedEvent);
Â  Â  Â  Â  detailsBox.classList.remove('hidden');
Â  Â  Â  Â  updateStatisticsDisplay(eventId);

Â  Â  Â  Â  // æ ¹æ“šç”¨æˆ¶ç‹€æ…‹è¨­å®šè¡¨å–®å’ŒæŒ‰éˆ•
Â  Â  Â  Â  if(SIGNUP_STATUSES.includes(userStatus)){
Â  Â  Â  Â  Â  Â  getEl('count').value = currentUserSignup.count;
Â  Â  Â  Â  Â  Â  getEl('guests').value = currentUserSignup.guests;
Â  Â  Â  Â  Â  Â  showButtons('edit'); // é¡¯ç¤ºä¿®æ”¹/å–æ¶ˆ
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  getEl('count').value='1';
Â  Â  Â  Â  Â  Â  getEl('guests').value='';
Â  Â  Â  Â  Â  Â  showButtons('new'); // é¡¯ç¤ºå ±å
Â  Â  Â  Â  Â  Â  if(userStatus==='CANCEL') {
Â  Â  Â  Â  Â  Â  Â  Â  alert("æ‚¨æ›¾å–æ¶ˆå ±åã€‚å¦‚æ¬²åƒåŠ è«‹æŒ‰ã€ç¢ºèªå ±åã€‘é‡æ–°å ±åã€‚");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  form.classList.remove('hidden');
Â  Â  } else{
Â  Â  Â  Â  form.classList.add('hidden'); detailsBox.classList.add('hidden'); statsBox.classList.add('hidden');
Â  Â  }
}

// ** è¼”åŠ©åŠŸèƒ½: é¡¯ç¤ºæ´»å‹•è©³æƒ… (å·²ä¿®æ­£åœ°åœ–é€£çµ)**
function displayEventDetails(data){
Â  Â  getEl('eventTitle').innerText = data.Title || "æ´»å‹•";
Â  Â  getEl('organizer').innerText = data.Organizer || "";
Â  Â  getEl('time').innerText = data.Time;
Â  Â  getEl('location').innerText = data.Location || "";
Â  Â  getEl('address').innerText = data.Address || "";
Â  Â  
Â  Â  // â­ ä¿®æ­£åœ°åœ–é€£çµï¼šä½¿ç”¨æ­£ç¢ºçš„æ¨¡æ¿å­—ä¸²èªæ³• ${è®Šæ•¸åç¨±}
Â  Â  const encodedAddress = encodeURIComponent(data.Address);
Â  Â  getEl('mapLinkBox').innerHTML = data.Address ?Â 
Â  Â  Â  Â  `<a href="https://www.google.com/maps/dir//`ã€‚æˆ‘å»ºè­°ä½¿ç”¨{encodedAddress}" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a>` : '';
}

// ** è¼”åŠ©åŠŸèƒ½: é¡¯ç¤ºå ±åçµ±è¨ˆ **
function updateStatisticsDisplay(eventId){
Â  Â  const statsBox = getEl('statistics-box');
Â  Â  const currentStats = ALL_EVENT_STATS ? ALL_EVENT_STATS[eventId] : null;
Â  Â  statsBox.classList.remove('hidden');
Â  Â  if(currentStats){
Â  Â  Â  Â  getEl('statSignupCount').innerText = currentStats.signupCount;
Â  Â  Â  Â  getEl('statTotalCount').innerText = currentStats.totalCount;
Â  Â  Â  Â  let nameListHtml = currentStats.nameList.map((name,index)=>(index>0 && index%5===0?`\n${name}`:name)).join('ã€');
Â  Â  Â  Â  getEl('nameList').innerText = nameListHtml||"ç›®å‰å°šç„¡å ±åè€…ã€‚";
Â  Â  } else{
Â  Â  Â  Â  getEl('statSignupCount').innerText=0;
Â  Â  Â  Â  getEl('statTotalCount').innerText=0;
Â  Â  Â  Â  getEl('nameList').innerText="ç›®å‰å°šç„¡å ±åè€…ã€‚";
Â  Â  }
}

// ** è¼”åŠ©åŠŸèƒ½: é¡¯ç¤º/éš±è—æŒ‰éˆ• **
function showButtons(mode){
Â  Â  const signupBtn=getEl('signupBtn');
Â  Â  const updateBtn=getEl('updateBtn');
Â  Â  const cancelBtn=getEl('cancelBtn');
Â  Â  if(mode==='edit'){Â 
Â  Â  Â  Â  signupBtn.classList.add('hidden');Â 
Â  Â  Â  Â  updateBtn.classList.remove('hidden');Â 
Â  Â  Â  Â  cancelBtn.classList.remove('hidden');Â 
Â  Â  }
Â  Â  else{Â 
Â  Â  Â  Â  signupBtn.classList.remove('hidden');Â 
Â  Â  Â  Â  updateBtn.classList.add('hidden');Â 
Â  Â  Â  Â  cancelBtn.classList.add('hidden');Â 
Â  Â  }
}

// ** æ ¸å¿ƒåŠŸèƒ½ 3: æäº¤è¡¨å–®è³‡æ–™ (POST Request) **
async function handleSubmit(action){
Â  Â  const buttons = [getEl('signupBtn'), getEl('updateBtn'), getEl('cancelBtn')];
Â  Â  const currentBtn = getEl(action + 'Btn');
Â  Â  const originalText = currentBtn.innerText;
Â  Â Â 
Â  Â  // 1. ç¢ºèª/é©—è­‰
Â  Â  if(action==='cancel' && !confirm("ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿæ­¤æ“ä½œå°‡å–æ¶ˆæ‚¨ç›®å‰çš„æœ‰æ•ˆå ±åç´€éŒ„ã€‚")) return;

Â  Â  const formData={
Â  Â  Â  Â  action:action,
Â  Â  Â  Â  lineUserId:getEl('lineUserId').value,
Â  Â  Â  Â  lineName:getEl('lineName').value,
Â  Â  Â  Â  eventId:getEl('eventID').value,
Â  Â  Â  Â  count:getEl('count').value,
Â  Â  Â  Â  guests:getEl('guests').value
Â  Â  };

Â  Â  if(!formData.eventId){ alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æ´»å‹•ï¼"); return; }
Â  Â  if((action==='signup'||action==='update') && (parseInt(formData.count)<=0||!formData.count)){ alert("åƒåŠ äººæ•¸è‡³å°‘ç‚º 1 äºº (å«æœ¬äºº)ï¼"); return; }

Â  Â  // 2. é–å®šæ‰€æœ‰æŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
Â  Â  buttons.forEach(btn => btn.disabled = true);
Â  Â  currentBtn.innerText = "è™•ç†ä¸­...";

Â  Â  try{
Â  Â  Â  Â  const response = await fetch(GAS_URL,{
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  body:JSON.stringify(formData),
Â  Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'}
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  if(result && result.status === 'success'){
Â  Â  Â  Â  Â  Â  alert(action==='cancel'?'âœ… å·²æˆåŠŸå–æ¶ˆå ±åï¼':'âœ… è³‡æ–™å·²æˆåŠŸé€å‡ºï¼');
Â  Â  Â  Â  Â  Â  // æˆåŠŸå¾Œæ‰é—œé–‰ LIFF è¦–çª—
Â  Â  Â  Â  Â  Â  setTimeout(()=>{ if(liff.isInClient()){ liff.closeWindow(); } },500);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert('âŒ è³‡æ–™é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ï¼' + (result.message ? `\n\néŒ¯èª¤è¨Šæ¯: ${result.message}` : ""));
Â  Â  Â  Â  }

Â  Â  }catch(err){Â 
Â  Â  Â  Â  console.error("æäº¤éŒ¯èª¤:", err);Â 
Â  Â  Â  Â  let userMsg = 'âŒ ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯è¨­å®šï¼';
Â  Â  Â  Â  if (err.message.includes("Failed to fetch") || err.message.includes("CORS")) {
Â  Â  Â  Â  Â  Â  Â userMsg = 'âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèª GAS éƒ¨ç½²çš„ã€å­˜å–æ¬Šã€‘æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€ï¼';
Â  Â  Â  Â  } else if (err.message.includes("HTTP")) {
Â  Â  Â  Â  Â  Â  Â userMsg = `âŒ ä¼ºæœå™¨å›å‚³éŒ¯èª¤ï¼š${err.message}ã€‚`;
Â  Â  Â  Â  }
Â  Â  Â  Â  alert(userMsg);Â 
Â  Â  } finally {
Â  Â  Â  Â  // 3. è§£é–æŒ‰éˆ•
Â  Â  Â  Â  buttons.forEach(btn => btn.disabled = false);
Â  Â  Â  Â  currentBtn.innerText = originalText;
Â  Â  }
}
</script>

</body>
</html>
