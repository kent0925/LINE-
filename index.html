<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å„é …æ´»å‹•å ±åè¡¨å–®</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root {
    --primary-color: #00796b; /* æ·±ç¶  (Primary) */
    --secondary-color: #4db6ac; /* æ·ºç¶  (Accent) */
    --bg-color: #f0f8ff; /* æ·ºè—ç™½ (Background) */
    --box-bg-color: #ffffff; /* ç™½è‰² (Card Background) */
    --input-bg-color: #f9f9f9; /* è¼¸å…¥æ¬„ä½æ·ºç° */
    --success-color: #4caf50; /* æˆåŠŸç¶  */
    --warning-color: #ff9800; /* è­¦å‘Šæ©˜ */
    --danger-color: #e53935; /* å±éšªç´… */
    --stat-color: #00897b; /* çµ±è¨ˆæ·±ç¶  */
    --border-color: #e0e0e0; /* é‚Šæ¡†æ·ºç° */
}
body { 
    font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
    background-color: var(--bg-color); 
    padding: 0;
    margin: 0;
}
.container { 
    max-width: 500px; 
    margin: 20px auto; 
    background: var(--box-bg-color); 
    padding: 25px; 
    border-radius: 16px; /* æ›´åœ“æ½¤ */
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* æ›´æ˜é¡¯çš„é™°å½± */
}
h2 { 
    text-align: center; 
    color: var(--primary-color); 
    border-bottom: 3px solid var(--secondary-color); 
    padding-bottom: 12px; 
    margin-bottom: 30px; 
    font-size: 1.8em;
}

/* è³‡è¨Šå¡ç‰‡å€å¡Š */
.info-box, .statistics-box { 
    background: var(--box-bg-color); 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 25px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* è¼•å¾®é™°å½± */
    border: 1px solid var(--border-color);
}
.info-box h3, .statistics-box h3 {
    margin-top: 0;
    font-size: 1.2em;
    color: var(--primary-color);
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.info-item { 
    margin-bottom: 8px; 
    line-height: 1.5; 
    display: flex; /* ä½¿ç”¨ Flex æ’ç‰ˆ */
}
.info-label { 
    font-weight: bold; 
    color: #333; 
    min-width: 50px; /* çµ±ä¸€æ¨™ç±¤å¯¬åº¦ */
    margin-right: 10px;
}
#mapLinkBox a { color: var(--secondary-color) !important; text-decoration: underline; font-weight: bold; }


/* è¡¨å–®æ¬„ä½è¨­è¨ˆ */
label { 
    display: block; 
    margin-top: 20px; 
    margin-bottom: 5px;
    font-weight: bold; 
    color: var(--primary-color); /* è®“æ¨™ç±¤æ›´çªå‡º */
    font-size: 1.05em;
}
input, select, textarea { 
    width: 100%; 
    padding: 12px; /* å¢åŠ é»æ“Šå€åŸŸ */
    background-color: var(--input-bg-color);
    border: 1px solid var(--border-color); 
    border-radius: 8px; 
    box-sizing: border-box; 
    transition: border-color 0.3s, box-shadow 0.3s; 
}
input:focus, select:focus, textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2); /* ç„¦é»è—è‰²å…‰æšˆ */
    background-color: var(--box-bg-color);
}
input[readonly] {
    background-color: #e8e8e8;
    color: #666;
    font-weight: bold;
}

/* æŒ‰éˆ•çµ„è¨­è¨ˆ */
.btn-group { 
    margin-top: 40px; 
    display: flex; 
    flex-direction: column; /* æ”¹ç‚ºå‚ç›´å †ç–Šä»¥å„ªåŒ–è¡Œå‹•è£ç½®é«”é©— */
    gap: 15px; 
}
button { 
    width: 100%;
    padding: 15px; /* å¢åŠ é»æ“Šå€åŸŸ */
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-size: 1.1em; 
    color: white; 
    font-weight: bold; 
    transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
}
#signupBtn { background-color: var(--success-color); }
#updateBtn { background-color: var(--warning-color); }
#cancelBtn { background-color: var(--danger-color); }
button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
button:disabled { background-color: #b0bec5; cursor: not-allowed; box-shadow: none; transform: none; }

/* çµ±è¨ˆå€å¡Š */
.statistics-box { 
    background-color: #e8f5e9; /* æ·ºç¶ åº•è‰² */
    border: 1px solid var(--success-color); 
    padding: 20px; 
    border-radius: 12px; 
    margin-top: 30px; 
}
.statistics-box h3 { 
    color: var(--stat-color); 
    margin-top: 0; 
    margin-bottom: 10px; 
    border-bottom: 2px solid var(--stat-color); 
    padding-bottom: 5px; 
    font-size: 1.2em; 
    display: flex;
    align-items: center;
}
.statistics-box h3::before {
    content: "ğŸ“Š";
    margin-right: 8px;
    font-size: 1.1em;
}
.stat-item { 
    font-weight: 500; 
    color: #333; 
    margin-bottom: 8px; 
    padding-left: 10px;
    border-left: 3px solid var(--secondary-color);
}
#nameList { 
    margin-top: 15px; 
    font-size: 0.9em; 
    line-height: 1.8; 
    color: #555; 
    white-space: pre-wrap; 
    padding: 10px;
    background-color: #ffffff;
    border: 1px solid #eee;
    border-radius: 6px;
}

/* éš±è—å…ƒç´  */
.hidden { display: none !important; }

/* é¸é …è¼‰å…¥ä¸­ */
#loading {
    padding: 10px;
    background-color: #fff3e0;
    border-radius: 6px;
    border: 1px solid var(--warning-color);
    margin-top: 15px;
    color: #555;
    font-style: italic;
}
</style>
</head>
<body>

<div class="container">
<h2 id="pageTitle">æ´»å‹•å ±åè¡¨å–®</h2>

<div id="event-selection-area" class="info-box" style="padding: 15px; background: #fff;">
<label for="event-select" style="margin-top: 0;">è«‹é¸æ“‡æ´»å‹•</label>
<select id="event-select" onchange="handleEventSelection()">
Â  Â  <option value="" disabled selected>-- è«‹é¸æ“‡ä¸€å€‹æ´»å‹• --</option>
</select>
<div id="loading" style="margin-top: 10px; color: #666;">æ­£åœ¨è¼‰å…¥æ´»å‹•è³‡è¨Š...</div>
</div>

<div id="event-details-box" class="info-box hidden">
    <h3>æ´»å‹•è©³ç´°è³‡è¨Š</h3>
    <div class="info-item"><span class="info-label">ä¸»é¡Œ</span> <span id="eventTitle">...</span></div>
    <div class="info-item"><span class="info-label">ä¸»è¾¦</span> <span id="organizer">...</span></div>
    <div class="info-item"><span class="info-label">æ™‚é–“</span> <span id="time">...</span></div>
    <div class="info-item"><span class="info-label">åœ°é»</span> <span id="location">...</span></div>
    <div class="info-item"><span class="info-label">åœ°å€</span> <span id="address">...</span></div>
    <div class="info-item" id="mapLinkBox"></div>
</div>

<form id="mainForm" class="hidden">
<input type="hidden" id="lineUserId">
<input type="hidden" id="eventID">Â 
<label>åƒåŠ äººå§“å (LINE)</label>
<input type="text" id="lineName" readonly placeholder="è®€å–ä¸­...">
<label>åƒåŠ äººæ•¸ (å«æœ¬äººåŠä¾†è³“)</label>
<select id="count">
Â  Â  <option value="1">1</option><option value="2">2</option><option value="3">3</option>
Â  Â  <option value="4">4</option><option value="5">5</option><option value="6">6</option>
Â  Â  <option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
</select>
<label>ä¾†è³“å§“å</label>
<textarea id="guests" rows="3" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜, æå¤§è¯"></textarea>

<div class="btn-group">
<button type="button" id="signupBtn" class="hidden" onclick="handleSubmit('signup')">ç¢ºèªå ±å</button>
<button type="button" id="updateBtn" class="hidden" onclick="handleSubmit('update')">ä¿®æ”¹è³‡æ–™</button>
<button type="button" id="cancelBtn" class="hidden" onclick="handleSubmit('cancel')">å–æ¶ˆå ±å</button>
</div>
</form>

<div id="statistics-box" class="statistics-box hidden">
    <h3>å³æ™‚å ±åç‹€æ³</h3>
    <div class="stat-item">å ±åç­†æ•¸ (LINE ID)ï¼š <span id="statSignupCount">0</span> ç­†</div>
    <div class="stat-item">ç¸½åƒåŠ äººæ•¸ï¼š <span id="statTotalCount">0</span> äºº</div>
    <h4 style="color: var(--stat-color); margin-top: 15px; margin-bottom: 5px; font-size: 1em;">å·²å ±åè€…åå–® (LINE æš±ç¨±)ï¼š</h4>
    <div id="nameList">è¼‰å…¥ä¸­...</div>
</div>

</div>

<script>
// ==================== [è«‹å‹™å¿…æ›´æ–°] æ‚¨çš„ LIFF ID ====================
const LIFF_ID = "2008678090-b1Up4o0J";Â  
// ==================== [è«‹å‹™å¿…æ›´æ–°] æ‚¨çš„ Google Apps Script URL ====================
const GAS_URL = "https://script.google.com/macros/s/AKfycbxcIzFs_FYtXPFWgFiDUNkyIaTjZoD1830iuJGF_IsPF_-flxWz2vtrkEydTU4mgkDl/exec";Â 

let ALL_EVENTS = [];
let USER_SIGNUP_DATA = {};
let ALL_EVENT_STATS = null;
const SIGNUP_STATUSES = ['SIGNUP','UPDATE'];

window.onload = async function() {
Â  Â  await initLIFF();
};

async function initLIFF() {
Â  Â  try {
Â  Â  Â  Â  await liff.init({ liffId: LIFF_ID });
Â  Â  Â  Â  if (liff.isLoggedIn()) {
Â  Â  Â  Â  Â  Â  const profile = await liff.getProfile();
Â  Â  Â  Â  Â  Â  const userName = profile.displayName;
Â  Â  Â  Â  Â  Â  const userId = profile.userId;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('lineName').value = userName;
Â  Â  Â  Â  Â  Â  document.getElementById('lineUserId').value = userId;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('pageTitle').innerText = 'æ´»å‹•å ±åè¡¨å–® - ' + userName;
Â  Â  Â  Â  Â  Â  await fetchData(userId);Â 
Â  Â  Â  Â  } else { liff.login(); }
Â  Â  } catch (err) { alert('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message); }
}

async function fetchData(userId) {Â 
Â  Â  try {
Â  Â  Â  Â  document.getElementById('loading').innerText = 'æ­£åœ¨è®€å–æ´»å‹•è³‡æ–™...';
Â  Â  Â  Â  const url = `${GAS_URL}?u=${encodeURIComponent(userId)}`;
Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  document.getElementById('loading').classList.add('hidden');

Â  Â  Â  Â  if(data.status==='error'){ alert("å¾Œç«¯è¨­å®šéŒ¯èª¤ï¼š" + data.message); return; }

Â  Â  Â  Â  ALL_EVENTS = data.eventList || [];
Â  Â  Â  Â  ALL_EVENT_STATS = data.eventStats;
Â  Â  Â  Â  USER_SIGNUP_DATA = data.userData && typeof data.userData==='object' ? data.userData : {};

Â  Â  Â  Â  if(ALL_EVENTS.length===0){
Â  Â  Â  Â  Â  Â  document.getElementById('event-selection-area').innerHTML = '<div style="color:red; font-weight:bold;">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•ï¼</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  populateEventSelect(ALL_EVENTS);

Â  Â  Â  Â  let selectedEventId = ALL_EVENTS[0].EventID;
Â  Â  Â  Â  if(selectedEventId){ document.getElementById('event-select').value = selectedEventId; }
Â  Â  Â  Â  handleEventSelection();

Â  Â  } catch(err){ console.error(err); alert("è®€å–æ´»å‹•æˆ–å ±åè³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯è¨­å®šã€‚"); }
}

function populateEventSelect(events){
Â  Â  const select = document.getElementById('event-select');
Â  Â  select.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡ä¸€å€‹æ´»å‹• --</option>';
Â  Â  events.forEach(event=>{
Â  Â  Â  Â  let optionText = `${event.Title} (${event.Time})`;
Â  Â  Â  Â  const userStatus = USER_SIGNUP_DATA[event.EventID] ? String(USER_SIGNUP_DATA[event.EventID].status).toUpperCase() : 'NONE';
Â  Â  Â  Â  if(SIGNUP_STATUSES.includes(userStatus)){ optionText += ' (å·²å ±å)'; }
Â  Â  Â  Â  else if(userStatus==='CANCEL'){ optionText += ' (å·²å–æ¶ˆ)'; }
Â  Â  Â  Â  select.innerHTML += `<option value="${event.EventID}">${optionText}</option>`;
Â  Â  });
}

function handleEventSelection(){
Â  Â  const select = document.getElementById('event-select');
Â  Â  const eventId = select.value;
Â  Â  const form = document.getElementById('mainForm');
Â  Â  const detailsBox = document.getElementById('event-details-box');
Â  Â  const statsBox = document.getElementById('statistics-box');

Â  Â  if(!eventId){ form.classList.add('hidden'); detailsBox.classList.add('hidden'); statsBox.classList.add('hidden'); return; }

Â  Â  document.getElementById('eventID').value = eventId;
Â  Â  const selectedEvent = ALL_EVENTS.find(e=>e.EventID===eventId);
Â  Â  const currentUserSignup = USER_SIGNUP_DATA[eventId];
Â  Â  let userStatus = currentUserSignup && currentUserSignup.status ? String(currentUserSignup.status).toUpperCase() : 'NONE';

Â  Â  if(selectedEvent){
Â  Â  Â  Â  displayEventDetails(selectedEvent);
Â  Â  Â  Â  detailsBox.classList.remove('hidden');
Â  Â  Â  Â  updateStatisticsDisplay(eventId);

Â  Â  Â  Â  if(SIGNUP_STATUSES.includes(userStatus)){
Â  Â  Â  Â  Â  Â  document.getElementById('count').value = currentUserSignup.count;
Â  Â  Â  Â  Â  Â  document.getElementById('guests').value = currentUserSignup.guests;
Â  Â  Â  Â  Â  Â  showButtons('edit');
Â  Â  Â  Â  } else if(userStatus==='CANCEL'){
Â  Â  Â  Â  Â  Â  document.getElementById('count').value='1';
Â  Â  Â  Â  Â  Â  document.getElementById('guests').value='';
Â  Â  Â  Â  Â  Â  showButtons('new');
Â  Â  Â  Â  Â  Â  alert("æ‚¨ç›®å‰å°æ­¤æ´»å‹•çš„ç‹€æ…‹ç‚ºã€å·²å–æ¶ˆã€‘ï¼Œå¦‚æ¬²åƒåŠ è«‹æŒ‰ã€ç¢ºèªå ±åã€‘é‡æ–°å ±åã€‚");
Â  Â  Â  Â  } else{
Â  Â  Â  Â  Â  Â  document.getElementById('count').value='1';
Â  Â  Â  Â  Â  Â  document.getElementById('guests').value='';
Â  Â  Â  Â  Â  Â  showButtons('new');
Â  Â  Â  Â  }
Â  Â  Â  Â  form.classList.remove('hidden');
Â  Â  } else{
Â  Â  Â  Â  form.classList.add('hidden'); detailsBox.classList.add('hidden'); statsBox.classList.add('hidden');
Â  Â  }
}

function displayEventDetails(data){
Â  Â  document.getElementById('eventTitle').innerText = data.Title || "æ´»å‹•";
Â  Â  document.getElementById('organizer').innerText = data.Organizer || "";
Â  Â  document.getElementById('time').innerText = data.Time;
Â  Â  document.getElementById('location').innerText = data.Location || "";
Â  Â  document.getElementById('address').innerText = data.Address || "";
    // ä¿®æ­£åœ°åœ–é€£çµçµ„è£èªæ³•ï¼Œä½¿ç”¨æ¨™æº–çš„ q åƒæ•¸
Â  Â  document.getElementById('mapLinkBox').innerHTML = data.Address ? 
Â  Â  Â  Â  `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.Address)}" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a>` : '';
}

function updateStatisticsDisplay(eventId){
Â  Â  const statsBox = document.getElementById('statistics-box');
Â  Â  const currentStats = ALL_EVENT_STATS ? ALL_EVENT_STATS[eventId] : null;
Â  Â  statsBox.classList.remove('hidden');
Â  Â  if(currentStats){
Â  Â  Â  Â  document.getElementById('statSignupCount').innerText = currentStats.signupCount;
Â  Â  Â  Â  document.getElementById('statTotalCount').innerText = currentStats.totalCount;
        // æ¯ 5 å€‹åå­—æ›è¡Œ
Â  Â  Â  Â  let nameListHtml = currentStats.nameList.map((name,index)=>(index>0 && index%5===0?`\n${name}`:name)).join('ã€');
Â  Â  Â  Â  document.getElementById('nameList').innerText = nameListHtml||"ç›®å‰å°šç„¡å ±åè€…ã€‚";
Â  Â  } else{
Â  Â  Â  Â  document.getElementById('statSignupCount').innerText=0;
Â  Â  Â  Â  document.getElementById('statTotalCount').innerText=0;
Â  Â  Â  Â  document.getElementById('nameList').innerText="ç›®å‰å°šç„¡å ±åè€…ã€‚";
Â  Â  }
}

function showButtons(mode){
Â  Â  const signupBtn=document.getElementById('signupBtn');
Â  Â  const updateBtn=document.getElementById('updateBtn');
Â  Â  const cancelBtn=document.getElementById('cancelBtn');
Â  Â  if(mode==='edit'){ 
        signupBtn.classList.add('hidden'); 
        updateBtn.classList.remove('hidden'); 
        cancelBtn.classList.remove('hidden'); 
    }
Â  Â  else{ 
        signupBtn.classList.remove('hidden'); 
        updateBtn.classList.add('hidden'); 
        cancelBtn.classList.add('hidden'); 
    }
}

// æ ¸å¿ƒå‡½å¼ï¼šé˜²æ­¢é‡è¤‡æäº¤é‚è¼¯
async function handleSubmit(action){
Â  Â  // 1. ç¢ºèª/é©—è­‰
Â  Â  if(action==='cancel' && !confirm("ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿæ­¤æ“ä½œå°‡å–æ¶ˆæ‚¨ç›®å‰çš„æœ‰æ•ˆå ±åç´€éŒ„ã€‚")) return;
Â  Â Â 
Â  Â  // 2. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
Â  Â  const btnId=action==='signup'?'signupBtn':(action==='update'?'updateBtn':'cancelBtn');
Â  Â  const btn=document.getElementById(btnId);
Â  Â  const originalText=btn.innerText;
Â  Â  btn.disabled=true; btn.innerText="è™•ç†ä¸­...";

Â  Â  const formData={
Â  Â  Â  Â  action:action,
Â  Â  Â  Â  lineUserId:document.getElementById('lineUserId').value,
Â  Â  Â  Â  lineName:document.getElementById('lineName').value,
Â  Â  Â  Â  eventId:document.getElementById('eventID').value,
Â  Â  Â  Â  count:document.getElementById('count').value,
Â  Â  Â  Â  guests:document.getElementById('guests').value
Â  Â  };

Â  Â  // åŸºæœ¬é©—è­‰
Â  Â  if(!formData.eventId){ alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æ´»å‹•ï¼"); btn.disabled=false; btn.innerText=originalText; return; }
Â  Â  if((action==='signup'||action==='update') && (parseInt(formData.count)<=0||!formData.count)){ alert("åƒåŠ äººæ•¸è‡³å°‘ç‚º 1 äºº (å«æœ¬äºº)ï¼"); btn.disabled=false; btn.innerText=originalText; return; }

Â  Â  try{
Â  Â  Â  Â  // 3. æäº¤è³‡æ–™ä¸¦ç­‰å¾…å¾Œç«¯ç¢ºèª (ç§»é™¤ no-cors ç¢ºä¿é€£ç·šå¯è¿½è¹¤)
Â  Â  Â  Â  const response = await fetch(GAS_URL,{
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  body:JSON.stringify(formData),
Â  Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'}
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  if(result && result.status === 'success'){
Â  Â  Â  Â  Â  Â  alert(action==='cancel'?'âœ… å·²æˆåŠŸå–æ¶ˆå ±åï¼':'âœ… è³‡æ–™å·²æˆåŠŸé€å‡ºï¼');
Â  Â  Â  Â  Â  Â  // æˆåŠŸå¾Œæ‰é—œé–‰ LIFF è¦–çª—
Â  Â  Â  Â  Â  Â  setTimeout(()=>{ if(liff.isInClient()){ liff.closeWindow(); } },500);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // è™•ç† GAS å›å‚³çš„éŒ¯èª¤è¨Šæ¯
Â  Â  Â  Â  Â  Â  alert('âŒ è³‡æ–™é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ï¼' + (result.message || ""));
Â  Â  Â  Â  Â  Â  btn.disabled=false; btn.innerText=originalText;
Â  Â  Â  Â  }

Â  Â  }catch(err){Â 
Â  Â  Â  Â  console.error("æäº¤éŒ¯èª¤:", err);Â 
Â  Â  Â  Â  alert('âŒ ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯è¨­å®šï¼');Â 
Â  Â  Â  Â  btn.disabled=false; btn.innerText=originalText;Â 
Â  Â  }
}
// ----------------------------------------------------------------
</script>

</body>
</html>
