<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>活動報名表</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family: Arial; max-width: 600px; margin: 20px auto;}
label{display:block;margin-top:10px;}
input, select, button{margin-top:5px; width:100%; padding:5px;}
button{width:auto; margin-right:5px;}
#guestSection{display:none; margin-top:10px;}
#statusMessage{margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:5px;}
</style>
</head>
<body>

<h2 id="eventTitle">活動名稱</h2>
<p>時間: <span id="eventTime">YYYY-MM-DD HH:MM</span></p>
<p>地點: <span id="eventLocation">活動地點</span> <button id="showMapBtn">地圖</button></p>

<label>您的姓名
<input type="text" id="userName" required>
</label>

<label>參加人數
<select id="attendeesCount">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</label>

<div id="guestSection">
<label>來賓姓名</label>
<div id="guestInputs"></div>
</div>

<div style="margin-top:10px;">
<button id="submitBtn">確認報名</button>
<button id="modifyBtn" style="display:none;">修改報名</button>
<button id="cancelBtn" style="display:none;">取消報名</button>
<button id="checkStatsBtn">查詢目前報名人數</button>
</div>

<div id="statusMessage"></div>

<script>
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz8o600QT2UGE97PL10yPrjne0pTHHScrvps2huCcBYgEOXENl5l6NDhjTfgPu-GWTEGw/exec'; // 請替換成你的 GAS 網址
const LIFF_ID = 'Y2008678090-b1Up4o0J'; // 請替換成你的 LIFF ID
let userId=''; 
let currentEventId='EVENT_ID'; // 當前活動 EventID

const userNameInput = document.getElementById('userName');
const attendeesCountSelect = document.getElementById('attendeesCount');
const guestInputsContainer = document.getElementById('guestInputs');
const guestSection = document.getElementById('guestSection');
const submitBtn = document.getElementById('submitBtn');
const modifyBtn = document.getElementById('modifyBtn');
const cancelBtn = document.getElementById('cancelBtn');
const checkStatsBtn = document.getElementById('checkStatsBtn');
const statusMessage = document.getElementById('statusMessage');
const eventTitle = document.getElementById('eventTitle');
const eventTime = document.getElementById('eventTime');
const eventLocation = document.getElementById('eventLocation');
const showMapBtn = document.getElementById('showMapBtn');

function updateGuestInputs(){
    const totalCount = parseInt(attendeesCountSelect.value,10);
    const guestCount = totalCount-1;
    guestInputsContainer.innerHTML='';
    if(guestCount>0){
        guestSection.style.display='block';
        for(let i=1;i<=guestCount;i++){
            const input=document.createElement('input');
            input.type='text';
            input.placeholder=`來賓 ${i} 姓名`;
            input.className='guest-name-input';
            guestInputsContainer.appendChild(input);
        }
    } else guestSection.style.display='none';
}

function collectFormData(action){
    const guests = Array.from(document.querySelectorAll('.guest-name-input')).map(i=>i.value);
    return {
        action: action,
        lineUserId: userId,
        lineName: userNameInput.value,
        eventId: currentEventId,
        count: attendeesCountSelect.value,
        guests: guests.join(', ')
    };
}

async function sendData(action){
    const formData = collectFormData(action);
    try{
        const res = await fetch(GAS_WEB_APP_URL,{
            method:'POST',
            body: JSON.stringify(formData)
        });
        const result = await res.json();
        if(result.status==='success'){
            statusMessage.textContent = action==='cancel'?'已取消報名':'操作成功';
            if(action==='signup'){
                submitBtn.style.display='none';
                modifyBtn.style.display='inline-block';
                cancelBtn.style.display='inline-block';
            }else if(action==='cancel'){
                submitBtn.style.display='inline-block';
                modifyBtn.style.display='none';
                cancelBtn.style.display='none';
            }
        }else statusMessage.textContent='失敗:'+result.message;
    }catch(err){
        statusMessage.textContent='網路錯誤';
        console.error(err);
    }
}

async function checkStats(){
    try{
        const res = await fetch(`${GAS_WEB_APP_URL}?action=getStats&eventId=${currentEventId}`);
        const data = await res.json();
        statusMessage.textContent=`目前總人數: ${data.totalCount}\n報名人員: ${data.attendeeNames.join(', ')}`;
    }catch(err){
        console.error(err);
        statusMessage.textContent='查詢失敗';
    }
}

async function initializeLiff(){
    await liff.init({liffId:LIFF_ID});
    if(!liff.isLoggedIn()) liff.login();
    else{
        const profile = await liff.getProfile();
        userId = profile.userId;
        userNameInput.value = profile.displayName;
    }
}

showMapBtn.addEventListener('click',()=>{
    const mapUrl=`https://www.google.com/maps/search/${encodeURIComponent(eventLocation.textContent)}`;
    if(liff.isInClient()){
        liff.openWindow({url:mapUrl,external:true});
    }else window.open(mapUrl,'_blank');
});

attendeesCountSelect.addEventListener('change', updateGuestInputs);
submitBtn.addEventListener('click', ()=>sendData('signup'));
modifyBtn.addEventListener('click', ()=>sendData('update'));
cancelBtn.addEventListener('click', ()=>sendData('cancel'));
checkStatsBtn.addEventListener('click', checkStats);

window.onload=()=>{
    initializeLiff();
    updateGuestInputs();
    // 可在此用 fetch 從 GAS 取得活動資訊並填入 eventTitle/eventTime/eventLocation
    // eventTitle.textContent = "活動名稱範例";
    // eventTime.textContent = "2025-12-25 14:00";
    // eventLocation.textContent = "台北市信義區...";
};
</script>

</body>
</html>
