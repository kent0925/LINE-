<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF å¤šæ´»å‹•å ±åè¡¨å–®</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* CSS æ¨£å¼éƒ¨åˆ† */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h1 { color: #00b900; border-bottom: 3px solid #00b900; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .info-card, .form-section, .stats-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .info-card h2, .form-section h2 { margin-top: 0; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-group { margin-top: 20px; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; transition: background-color 0.3s; }
        .btn-register { background-color: #00b900; color: white; }
        .btn-register:hover { background-color: #009900; }
        .btn-cancel { background-color: #ff3b30; color: white; }
        .btn-cancel:hover { background-color: #cc0000; }
        .btn-modify { background-color: #007aff; color: white; }
        .btn-modify:hover { background-color: #005bb5; }
        .message { padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; font-weight: bold; display: none; }
        .success { background-color: #e6ffe6; color: #009900; border: 1px solid #009900; }
        .error { background-color: #ffe6e6; color: #cc0000; border: 1px solid #cc0000; }
        .stats-list { list-style: none; padding-left: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .stats-list li { padding: 5px 0; border-bottom: 1px dotted #eee; }
        .stats-list li:last-child { border-bottom: none; }
        #form-actions { display: flex; justify-content: space-around; }
        .loading { text-align: center; padding: 30px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>å¤šæ´»å‹•å ±åè¡¨å–®</h1>

        <div id="loading-spinner" class="loading">
            <p>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>

        <div id="event-selection" class="form-section" style="display: none;">
            <h2>é¸æ“‡å ±åæ´»å‹•</h2>
            <label for="event-select">å¯å ±åæ´»å‹•åˆ—è¡¨</label>
            <select id="event-select" onchange="selectEvent(this.value)">
                <option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>
            </select>
            <div id="select-message" class="message"></div>
        </div>
        
        <div id="activity-info" class="info-card" style="display: none;">
            <h2>æ´»å‹•è³‡è¨Š - <span id="info-title"></span></h2>
            <p><strong>ä¸»è¾¦:</strong> <span id="info-organizer"></span></p>
            <p><strong>æ™‚é–“:</strong> <span id="info-time"></span></p>
            <p><strong>åœ°é»:</strong> <span id="info-location"></span> (<a id="info-map-link" href="#" target="_blank">Google åœ°åœ–</a>)</p>
        </div>

        <div id="registration-form" class="form-section" style="display: none;">
            <h2>æ‚¨çš„å ±åè³‡æ–™</h2>
            
            <p><strong>åƒåŠ äººå§“å:</strong> <span id="line-nickname">è¼‰å…¥ä¸­...</span></p>
            <input type="hidden" id="line-uid">

            <label for="attendees-count">åƒåŠ äººæ•¸ (å«æ‚¨æœ¬äºº)</label>
            <select id="attendees-count">
                </select>

            <label for="guest-names">ä¾†è³“å§“å (è«‹ç”¨é€—è™Ÿåˆ†éš”)</label>
            <textarea id="guest-names" rows="2" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜, é™³å°ç¾"></textarea>

            <div class="btn-group">
                <div id="form-actions">
                    </div>
            </div>

            <div id="form-message" class="message"></div>
        </div>

        <div id="statistics" class="stats-section" style="display: none;">
            <h2>å³æ™‚å ±åçµ±è¨ˆ</h2>
            <p>ç›®å‰ç¸½è¨ˆ **<span id="total-attendees">0</span>** äººåƒåŠ </p>
            <p>åƒåŠ è€…åå–®:</p>
            <ul id="registered-list" class="stats-list">
                </ul>
            <button class="btn btn-modify" onclick="if(CURRENT_EVENT_ID) loadStatsAndStatus(CURRENT_EVENT_ID, true)">é‡æ–°æ•´ç†çµ±è¨ˆ</button>
        </div>
    </div>

    <script>
        // !! è«‹å°‡ YOUR_GAS_WEB_APP_URL æ›¿æ›ç‚ºæ‚¨åœ¨æ­¥é©Ÿ 2 éƒ¨ç½² GAS å¾Œå–å¾—çš„ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ !!
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4TwMhhZns3p2jc2tVTI376-6DU9CG8tkuRmL3KKcq_BmIuB2ySV2CKgaCc5eyS2vLnA/exec';
        const LIFF_ID = '2008678090-aXTesgDK'; // æ‚¨çš„ LIFF ID
        
        let LINE_UID = '';
        let LINE_NICKNAME = '';
        let CURRENT_EVENT_ID = null; 
        let ALL_EVENTS = []; 

        // --- åˆå§‹åŒ– LIFF ---
        function initializeLiff() {
            liff.init({ liffId: LIFF_ID }) 
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        // å¦‚æœæ²’æœ‰ç™»å…¥ï¼Œè§¸ç™¼ç™»å…¥
                        liff.login();
                        return;
                    }
                    
                    if (!liff.getIDToken()) {
                        alert('ç„¡æ³•å–å¾— LINE è³‡è¨Šã€‚');
                        document.getElementById('loading-spinner').style.display = 'none';
                        return;
                    }
                    
                    liff.getProfile().then(profile => {
                        LINE_UID = profile.userId;
                        LINE_NICKNAME = profile.displayName;
                        document.getElementById('line-nickname').textContent = LINE_NICKNAME;
                        document.getElementById('line-uid').value = LINE_UID;
                        
                        // è¼‰å…¥æ´»å‹•åˆ—è¡¨
                        loadEventsList();
                        
                    }).catch(err => {
                        console.error("Error getting profile: ", err);
                        alert('ç„¡æ³•å–å¾— LINE å€‹äººè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                        document.getElementById('loading-spinner').style.display = 'none';
                    });

                })
                .catch((err) => {
                    console.error("LIFF initialization failed", err);
                    alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID å’Œ Endpoint URL è¨­å®šã€‚');
                    document.getElementById('loading-spinner').style.display = 'none';
                });
        }
        
        // --- è¼‰å…¥æ´»å‹•åˆ—è¡¨ ---
        async function loadEventsList() {
            try {
                const url = `${GAS_WEB_APP_URL}?action=getEventsList`;
                const response = await fetch(url);
                
                // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.status === 'success') {
                    ALL_EVENTS = result.events;
                    
                    // å¡«å……æ´»å‹•ä¸‹æ‹‰é¸å–®
                    renderEventDropdown(ALL_EVENTS);
                    
                    document.getElementById('event-selection').style.display = 'block';
                    
                    // ç”¢ç”ŸåƒåŠ äººæ•¸ä¸‹æ‹‰é¸å–® (åªéœ€ç”¢ç”Ÿä¸€æ¬¡)
                    const select = document.getElementById('attendees-count');
                    if (select.options.length === 0) {
                        for (let i = 1; i <= 10; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = i;
                            select.appendChild(option);
                        }
                    }

                } else {
                    displaySelectMessage('error', 'è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error("Fetch events list error:", error);
                displaySelectMessage('error', 'é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥æ´»å‹•åˆ—è¡¨ã€‚è«‹æª¢æŸ¥ GAS Web App URL å’Œéƒ¨ç½²ç‹€æ…‹ã€‚');
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }
        
        // --- æ¸²æŸ“æ´»å‹•ä¸‹æ‹‰é¸å–® (è™•ç†æ™‚é–“æ ¼å¼å·²åœ¨ GAS ç«¯å®Œæˆ) ---
        function renderEventDropdown(events) {
            const select = document.getElementById('event-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>'; 
            
            if (events.length === 0) {
                displaySelectMessage('error', 'ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•ã€‚');
                return;
            }
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.EventID;
                option.textContent = `${event.Title} (${event.Time})`;
                select.appendChild(option);
            });
        }
        
        // --- é¸æ“‡æ´»å‹•ï¼Œé¡¯ç¤ºè¡¨å–® ---
        function selectEvent(eventId) {
            if (!eventId) {
                hideFormAndStats();
                return;
            }
            
            CURRENT_EVENT_ID = eventId;
            const event = ALL_EVENTS.find(e => e.EventID === eventId);
            
            if (!event) {
                alert('æ´»å‹• ID éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚');
                hideFormAndStats();
                return;
            }
            
            // å¡«å……å–®ä¸€æ´»å‹•è³‡è¨Š
            document.getElementById('info-title').textContent = event.Title || 'N/A';
            document.getElementById('info-organizer').textContent = event.Organizer || 'N/A';
            document.getElementById('info-time').textContent = event.Time || 'N/A';
            document.getElementById('info-location').textContent = event.Location || 'N/A';
            document.getElementById('info-map-link').href = event.MapUrl || '#';
            
            // é¡¯ç¤ºè¡¨å–®å’Œçµ±è¨ˆå€å¡Š
            document.getElementById('activity-info').style.display = 'block';
            document.getElementById('registration-form').style.display = 'block';
            document.getElementById('statistics').style.display = 'block';
            
            // è¼‰å…¥ç‰¹å®šæ´»å‹•çš„çµ±è¨ˆå’Œç”¨æˆ¶ç‹€æ…‹
            loadStatsAndStatus(CURRENT_EVENT_ID);
        }

        // --- éš±è—è¡¨å–®å’Œçµ±è¨ˆå€å¡Š ---
        function hideFormAndStats() {
            CURRENT_EVENT_ID = null;
            document.getElementById('activity-info').style.display = 'none';
            document.getElementById('registration-form').style.display = 'none';
            document.getElementById('statistics').style.display = 'none';
            hideMessage();
        }
        
        // --- è¼‰å…¥çµ±è¨ˆæ•¸æ“šå’Œç”¨æˆ¶å ±åç‹€æ…‹ ---
        async function loadStatsAndStatus(eventId, isRefresh = false) {
            if (isRefresh) {
                document.getElementById('statistics').style.opacity = 0.5;
            }
            
            try {
                const url = `${GAS_WEB_APP_URL}?action=getStatsAndStatus&lineUid=${LINE_UID}&eventId=${eventId}`; 
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
                    document.getElementById('total-attendees').textContent = result.totalAttendees;
                    const list = document.getElementById('registered-list');
                    list.innerHTML = '';
                    if (result.registeredUsers.length > 0) {
                         result.registeredUsers.forEach(name => {
                            const li = document.createElement('li');
                            // æ¨™è¨˜ç›®å‰ç”¨æˆ¶
                            li.textContent = name + (name === LINE_NICKNAME ? ' (æ‚¨)' : ''); 
                            list.appendChild(li);
                        });
                    } else {
                        list.innerHTML = '<li>ç›®å‰é‚„æ²’æœ‰äººå ±åå–”ï¼</li>';
                    }
                    
                    // è™•ç†ç”¨æˆ¶å ±åç‹€æ…‹
                    const formActionsDiv = document.getElementById('form-actions');
                    formActionsDiv.innerHTML = '';
                    
                    if (result.userStatus && result.userStatus.Status === 'Registered') {
                        // å·²å ±åç‹€æ…‹
                        
                        // é å¡«å ±åè³‡æ–™
                        document.getElementById('attendees-count').value = result.userStatus.Attendees_Count;
                        document.getElementById('guest-names').value = result.userStatus.Guest_Names;
                        
                        // é¡¯ç¤ºä¿®æ”¹å’Œå–æ¶ˆæŒ‰éˆ•
                        formActionsDiv.innerHTML = `
                            <button class="btn btn-modify" onclick="handleRegistration('register')">âœ… ä¿®æ”¹å ±å</button>
                            <button class="btn btn-cancel" onclick="handleRegistration('cancel')">âŒ å–æ¶ˆå ±å</button>
                        `;
                        displayFormMessage('success', 'æ‚¨å·²å ±åæ­¤æ´»å‹•ï¼Œå¯ä»¥åœ¨æ­¤ä¿®æ”¹æˆ–å–æ¶ˆã€‚');
                        
                    } else {
                        // æœªå ±åæˆ–å·²å–æ¶ˆç‹€æ…‹
                        
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('attendees-count').value = 1;
                        document.getElementById('guest-names').value = '';
                        
                        // é¡¯ç¤ºå ±åæŒ‰éˆ•
                        formActionsDiv.innerHTML = `
                            <button class="btn btn-register" onclick="handleRegistration('register')">ğŸš€ ç¢ºèªå ±å</button>
                        `;
                        
                        if (result.userStatus && result.userStatus.Status === 'Cancelled') {
                            displayFormMessage('error', 'æ‚¨å·²å–æ¶ˆæ­¤æ´»å‹•å ±åï¼Œé»æ“Šã€Œç¢ºèªå ±åã€å¯é‡æ–°å ±åã€‚');
                        } else {
                            hideMessage();
                        }
                    }
                    
                } else {
                    displayFormMessage('error', 'è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                console.error("Fetch stats and status error:", error);
                displayFormMessage('error', 'é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥çµ±è¨ˆè³‡è¨Šã€‚');
            } finally {
                document.getElementById('statistics').style.opacity = 1;
            }
        }
        
        // --- è™•ç†å ±å/å–æ¶ˆ (POST åˆ° GAS) ---
        async function handleRegistration(action) {
            if (!CURRENT_EVENT_ID) {
                alert('è«‹å…ˆé¸æ“‡æ´»å‹•ï¼');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            displayFormMessage('none', 'è™•ç†ä¸­...');

            const attendeesCount = document.getElementById('attendees-count').value;
            const guestNames = document.getElementById('guest-names').value.trim();

            const postData = {
                action: action,
                eventId: CURRENT_EVENT_ID, 
                lineUid: LINE_UID,
                lineNickname: LINE_NICKNAME,
                attendeesCount: attendeesCount,
                guestNames: guestNames
            };
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    let msg = '';
                    const eventTitle = ALL_EVENTS.find(e => e.EventID === CURRENT_EVENT_ID)?.Title || 'æ­¤æ´»å‹•';
                    if (action === 'register') {
                        msg = `æ­å–œæ‚¨ï¼${eventTitle} å ±åæˆåŠŸï¼`;
                        if (result.message.includes('Update')) {
                            msg = `${eventTitle} çš„å ±åè³‡æ–™å·²æˆåŠŸä¿®æ”¹ï¼`;
                        }
                    } else if (action === 'cancel') {
                        msg = `${eventTitle} çš„å ±åå·²æˆåŠŸå–æ¶ˆã€‚`;
                    }
                    displayFormMessage('success', msg);
                    
                    loadStatsAndStatus(CURRENT_EVENT_ID);
                    sendLineMessage(action, eventTitle, attendeesCount);
                    
                } else {
                    displayFormMessage('error', result.message || 'å ±åè™•ç†å¤±æ•—ã€‚');
                }
            } catch (error) {
                console.error("Registration post error:", error);
                displayFormMessage('error', 'é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚');
            } finally {
                btn.disabled = false;
            }
        }

        // --- é¡¯ç¤º/éš±è—è¨Šæ¯ (è¡¨å–®å€åŸŸ) ---
        function displayFormMessage(type, text) {
            const msgBox = document.getElementById('form-message');
            msgBox.textContent = text;
            msgBox.className = `message ${type}`;
            msgBox.style.display = 'block';
            if (type === 'none') {
                msgBox.style.display = 'block'; 
                msgBox.className = `message`; 
            }
        }
        
        // --- é¡¯ç¤º/éš±è—è¨Šæ¯ (æ´»å‹•é¸æ“‡å€åŸŸ) ---
        function displaySelectMessage(type, text) {
            const msgBox = document.getElementById('select-message');
            msgBox.textContent = text;
            msgBox.className = `message ${type}`;
            msgBox.style.display = 'block';
        }

        function hideMessage() {
            document.getElementById('form-message').style.display = 'none';
        }
        
        // --- ç™¼é€ LINE è¨Šæ¯é€šçŸ¥ ---
        function sendLineMessage(action, eventTitle, attendeesCount) {
            if (!liff.isInClient()) {
                console.log("Not in LINE client, skip sending message.");
                return;
            }
            
            let msgText = '';
            if (action === 'register') {
                msgText = `âœ… ${eventTitle} å ±å/ä¿®æ”¹æˆåŠŸï¼\nåƒåŠ è€…ï¼š${LINE_NICKNAME}\nç¸½äººæ•¸ï¼š${attendeesCount} ä½\nè«‹é»æ“Šè¡¨å–®æŸ¥çœ‹è©³ç´°è³‡è¨Šã€‚`;
            } else if (action === 'cancel') {
                msgText = `âŒ ${eventTitle} å·²å–æ¶ˆå ±åã€‚\nåƒåŠ è€…ï¼š${LINE_NICKNAME}`;
            }
            
            if (msgText) {
                liff.sendMessages([{
                    type: 'text',
                    text: msgText
                }]).then(() => {
                    console.log('Message sent successfully');
                }).catch((err) => {
                    console.error('Error sending message:', err);
                });
            }
        }
        
        // å•Ÿå‹• LIFF
        document.addEventListener('DOMContentLoaded', initializeLiff);
    </script>

</body>
</html>
