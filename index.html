<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¤æœƒæ´»å‹•å ±åè¡¨å–®</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f5f5f5; }
.container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
h1 { color: #00b900; border-bottom: 3px solid #00b900; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
.info-card, .form-section, .stats-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
label { display:block; margin-top:10px; font-weight:bold; }
input[type="text"], select, textarea { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
.btn { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin:5px; }
.btn-register { background-color:#00b900; color:white; }
.btn-cancel { background-color:#ff3b30; color:white; }
.btn-modify { background-color:#007aff; color:white; }
.message { padding:10px; margin-top:15px; border-radius:4px; text-align:center; font-weight:bold; display:none; }
.success { background-color:#e6ffe6; color:#009900; border:1px solid #009900; }
.error { background-color:#ffe6e6; color:#cc0000; border:1px solid #cc0000; }
.stats-list { list-style:none; padding-left:0; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:4px; }
.stats-list li { padding:5px 0; border-bottom:1px dotted #eee; }
.stats-list li:last-child { border-bottom:none; }
#form-actions { display:flex; justify-content:space-around; }
.loading { text-align:center; padding:30px; }

/* â­ï¸ æ–°å¢ï¼šåœ°åœ–é€£çµæŒ‰éˆ•æ¨£å¼ */
.btn-map {
    display: inline-block;
    padding: 3px 8px; 
    margin-left: 10px;
    background-color: #4285F4; /* Google è—è‰² */
    color: white !important;
    text-decoration: none;
    border-radius: 4px;
    font-weight: normal; 
    font-size: 0.9em;
}
.btn-map:hover {
    background-color: #357ae8; 
}
</style>
</head>
<body>

<div class="container">
<h1>å¤šæ´»å‹•å ±åè¡¨å–®</h1>

<div id="loading-spinner" class="loading"><p>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p></div>

<div id="event-selection" class="form-section" style="display:none;">
<h2>é¸æ“‡å ±åæ´»å‹•</h2>
<label for="event-select">å¯å ±åæ´»å‹•åˆ—è¡¨</label>
<select id="event-select" onchange="selectEvent(this.value)">
Â  <option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>
</select>
<div id="select-message" class="message"></div>
</div>

<div id="activity-info" class="info-card" style="display:none;">
<h2>æ´»å‹•è³‡è¨Š - <span id="info-title"></span></h2>
<p><strong>ä¸»è¾¦:</strong> <span id="info-organizer"></span></p>
<p><strong>æ™‚é–“:</strong> <span id="info-time"></span></p>
<p><strong>åº—å:</strong> <span id="info-venue-name"></span></p>Â 
<p><strong>åœ°é»:</strong> <span id="info-location"></span> (<a id="info-map-link" href="#" target="_blank" aria-label="é–‹å•Ÿ Google åœ°åœ–" class="btn-map">ğŸ“Œ é–‹å•Ÿåœ°åœ–</a>)</p> </div>

<div id="registration-form" class="form-section" style="display:none;">
<h2>æ‚¨çš„å ±åè³‡æ–™</h2>
<p><strong>åƒåŠ äººå§“å:</strong> <span id="line-nickname">è¼‰å…¥ä¸­...</span></p>
<input type="hidden" id="line-uid">

<label for="attendees-count">åƒåŠ äººæ•¸ (å«æœ¬äººåŠä¾†è³“)</label>
<select id="attendees-count"></select>

<label for="guest-names">ä¾†è³“å§“å (é€—è™Ÿåˆ†éš”)</label>
<textarea id="guest-names" rows="2" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜, é™³å°ç¾"></textarea>

<div id="form-actions">
Â  <button class="btn btn-register" onclick="submitRegistration('register')">å ±å</button>
Â  <button class="btn btn-cancel" onclick="submitRegistration('cancel')">å–æ¶ˆå ±å</button>
Â  <button class="btn btn-modify" onclick="submitRegistration('edit')">ç·¨è¼¯</button>
</div>

<div id="form-message" class="message"></div>
</div>

<div id="statistics" class="stats-section" style="display:none;">
<h2>å³æ™‚å ±åçµ±è¨ˆ</h2>
<p>ç›®å‰ç¸½è¨ˆ **<span id="total-attendees">0</span>** äººåƒåŠ </p>
<p>åƒåŠ è€…åå–®:</p>
<ul id="registered-list" class="stats-list"></ul>
<button class="btn btn-modify" onclick="if(CURRENT_EVENT_ID) loadStatsAndStatus(CURRENT_EVENT_ID,true)">é‡æ–°æ•´ç†çµ±è¨ˆ</button>
</div>
</div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbz4TwMhhZns3p2jc2tVTI376-6DU9CG8tkuRmL3KKcq_BmIuB2ySV2CKgaCc5eyS2vLnA/exec';
let LINE_UID='', LINE_NICKNAME='', CURRENT_EVENT_ID=null, ALL_EVENTS=[];

async function initializeLiff(){
Â  Â  await liff.init({liffId:'2008678090-aXTesgDK'});
Â  Â  if(!liff.isLoggedIn()){ liff.login(); return; }
Â  Â  const profile = await liff.getProfile();
Â  Â  LINE_UID = profile.userId;
Â  Â  LINE_NICKNAME = profile.displayName;
Â  Â  document.getElementById('line-nickname').textContent = LINE_NICKNAME;
Â  Â  document.getElementById('line-uid').value = LINE_UID;
Â  Â  loadEventsList();
}

async function loadEventsList(){
Â  Â  const res = await fetch(`${GAS_URL}?action=getEventsList&lineUid=${LINE_UID}`);
Â  Â  const data = await res.json();
Â  Â  if(data.status==='success'){
Â  Â  Â  Â  ALL_EVENTS = data.events;
Â  Â  Â  Â  const sel=document.getElementById('event-select');
Â  Â  Â  Â  sel.innerHTML=`<option value="">-- è«‹é¸æ“‡ä¸€é …æ´»å‹• --</option>`;
Â  Â  Â  Â  ALL_EVENTS.forEach(ev=>{
Â  Â  Â  Â  Â  Â  let label=`${ev.Title} (${formatLocalTime(ev.Time)})`;
Â  Â  Â  Â  Â  Â  if(ev.UserRegistered) label+=' [å·²å ±å]';
Â  Â  Â  Â  Â  Â  sel.innerHTML+=`<option value="${ev.EventID}">${label}</option>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('event-selection').style.display='block';
Â  Â  Â  Â  const countSel=document.getElementById('attendees-count');
Â  Â  Â  Â  countSel.innerHTML='';
Â  Â  Â  Â  for(let i=1;i<=10;i++) countSel.innerHTML+=`<option value="${i}">${i}</option>`;
Â  Â  Â  Â  document.getElementById('loading-spinner').style.display='none';
Â  Â  }
}

function formatLocalTime(isoStr){
Â  Â  const d = new Date(isoStr);
Â  Â  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function pad(n){ return n<10 ? '0'+n : n; }

function selectEvent(eventId){
Â  Â  if(!eventId) return;
Â  Â  CURRENT_EVENT_ID = eventId;
Â  Â  const ev = ALL_EVENTS.find(e=>e.EventID===eventId);
Â  Â  document.getElementById('activity-info').style.display='block';
Â  Â  document.getElementById('info-title').textContent = ev.Title;
Â  Â  document.getElementById('info-organizer').textContent = ev.Organizer;
Â  Â  document.getElementById('info-time').textContent = formatLocalTime(ev.Time);
Â  Â Â 
Â  Â  document.getElementById('info-venue-name').textContent = ev.VenueName; // â­ï¸ æ–°å¢ï¼šè®€å–ä¸¦é¡¯ç¤º VenueName
Â  Â Â 
Â  Â  document.getElementById('info-location').textContent = ev.Address;
Â  Â  document.getElementById('info-map-link').href = ev.MapUrl;
Â  Â  document.getElementById('registration-form').style.display='block';
Â  Â  loadStatsAndStatus(eventId);
}

async function loadStatsAndStatus(eventId, force=false){
Â  Â  if(!eventId) return;
Â  Â  const res = await fetch(`${GAS_URL}?action=getStatsAndStatus&lineUid=${LINE_UID}&eventId=${eventId}`);
Â  Â  const data = await res.json();
Â  Â  if(data.status==='success'){
Â  Â  Â  Â  document.getElementById('total-attendees').textContent = data.totalAttendees;
Â  Â  Â  Â  const ul = document.getElementById('registered-list');
Â  Â  Â  Â  ul.innerHTML = '';
Â  Â  Â  Â  data.registeredUsers.forEach(u=>ul.innerHTML+=`<li>${u.name} (${u.attendees}äºº)</li>`);
Â  Â  Â  Â  if(data.userStatus){
Â  Â  Â  Â  Â  Â  document.getElementById('attendees-count').value = data.userStatus.Attendees_Count||1;
Â  Â  Â  Â  Â  Â  document.getElementById('guest-names').value = data.userStatus.Guest_Names||'';
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('statistics').style.display='block';
Â  Â  }
}

async function submitRegistration(action){
Â  Â  if(!CURRENT_EVENT_ID) return;
Â  Â  const payload = {
Â  Â  Â  Â  action: action,
Â  Â  Â  Â  eventId: CURRENT_EVENT_ID,
Â  Â  Â  Â  lineUid: LINE_UID,
Â  Â  Â  Â  lineNickname: LINE_NICKNAME,
Â  Â  Â  Â  attendeesCount: parseInt(document.getElementById('attendees-count').value),
Â  Â  Â  Â  guestNames: document.getElementById('guest-names').value
Â  Â  };
Â  Â  const res = await fetch(GAS_URL,{method:'POST',body:JSON.stringify(payload)});
Â  Â  const data = await res.json();
Â  Â  const msgEl = document.getElementById('form-message');
Â  Â  msgEl.style.display='block';
Â  Â  if(data.status==='success'){ msgEl.className='message success'; msgEl.textContent = data.message; }
Â  Â  else{ msgEl.className='message error'; msgEl.textContent = data.message; }
Â  Â  loadStatsAndStatus(CURRENT_EVENT_ID,true);
Â  Â  loadEventsList();
}

initializeLiff();
</script>
</body>
</html>
